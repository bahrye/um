<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <style>
    body { 
      background-color: #f8f9fa; 
    }
    .main-container { 
      min-height: 100vh; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
    }
    #input-nilai-view, #login-view, #dashboard-view, #loading-view, 
    #cetak-nilai-view, #pengaturan-cetak-view { 
      display: none; 
    }
    .nilai-input { 
      width: 80px; 
      text-align: center; 
    }
    .nilai-input.is-invalid {
        border-color: #dc3545;
    }
    .clickable-card {
        cursor: pointer;
        transition: transform 0.2s;
    }
    .clickable-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .modal-backdrop {
        background-color: rgba(0,0,0,0.6);
    }
    
    .card-title i {
        font-size: 2.5rem;
        margin-bottom: 10px;
        display: block;
    }
  </style>
</head>
<body>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <div id="loading-view" class="main-container" style="display: flex;">
    <div class="text-center">
        <div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>
        <p class="mt-2">Memverifikasi sesi...</p>
    </div>
  </div>

  <div id="login-view" class="main-container">
    <div class="col-md-5 col-lg-4 col-sm-10">
      <div class="card shadow-sm">
        <div class="card-body p-4">
          <h3 class="text-center mb-1">Aplikasi Input Nilai</h3>
          <p class="text-center text-muted mb-4">Silakan login untuk melanjutkan</p>
          <div id="login-alert" class="alert alert-danger" style="display: none;"></div>
          <form onsubmit="event.preventDefault(); handleLogin();">
            <div class="form-group">
              <label for="email">Email</label>
              <input type="email" id="email" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="password">Password</label>
              <input type="password" id="password" class="form-control" required>
            </div>
            <button id="login-button" type="submit" class="btn btn-primary btn-block"><i class="bi bi-box-arrow-in-right"></i> Login</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div id="dashboard-view" class="container mt-4 mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 id="welcome-message-dash">Selamat Datang!</h4>
        <button class="btn btn-sm btn-outline-danger" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Logout</button>
    </div>
    <div class="card mb-4">
        <div class="card-header">
            Pengumuman
        </div>
        <div class="card-body">
            <p class="card-text">Selamat datang di aplikasi Ujian Madrasah. Silakan pilih salah satu menu di bawah ini untuk memulai. Pastikan data yang Anda masukkan sudah benar sebelum disimpan.</p>
        </div>
    </div>
    <div class="row text-center">
        <div class="col-md-4 mb-3">
            <div class="card clickable-card h-100" onclick="goToInputNilai()">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-pencil-square text-primary"></i>Input Nilai UM</h5>
                    <p class="card-text text-muted">Masuk untuk mengisi atau mengubah nilai siswa berdasarkan tahun ajaran.</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card clickable-card h-100" onclick="goToCetakNilai()">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-printer text-info"></i>Kirim dan Cetak Nilai UM</h5>
                    <p class="card-text text-muted">Pilih tahun ajaran dan mapel untuk mencetak laporan nilai akhir.</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card clickable-card h-100" onclick="goToPengaturanCetak()">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-gear text-secondary"></i>Pengaturan Cetak</h5>
                    <p class="card-text text-muted">Atur informasi tempat dan tanggal untuk tanda tangan pada laporan.</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            Status Kirim Nilai Guru
            <div class="col-md-5 col-lg-4">
                <select id="status-tahun-ajaran-select" class="form-control form-control-sm" onchange="fetchDashboardStatus()">
                </select>
            </div>
        </div>
        <div class="card-body">
            <div id="loading-spinner-status" class="text-center">
                <div class="spinner-border spinner-border-sm" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <p class="mt-1">Memuat status...</p>
            </div>
            <div id="status-table-container" class="table-responsive" style="display: none;">
                <table class="table table-striped table-bordered">
                    <thead class="thead-light">
                        <tr>
                            <th>Nama Guru</th>
                            <th>Mata Pelajaran</th>
                            <th class="text-center" style="width: 120px;">Status</th>
                            <th class="text-center" style="width: 150px;">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="status-table-body">
                    </tbody>
                </table>
            </div>
             <div id="status-table-error" class="text-center text-muted" style="display: none;">
                Gagal memuat data status. Silakan coba lagi nanti.
            </div>
        </div>
    </div>
  </div>

  <div class="modal fade" id="loadingModal" tabindex="-1" role="dialog" aria-labelledby="loadingModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-body text-center p-4">
          <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="sr-only">Loading...</span>
          </div>
          <p class="mt-3 mb-0">Sedang memproses unduhan PDF, mohon tunggu...</p>
        </div>
      </div>
    </div>
  </div>

  <div id="input-nilai-view" class="container mt-4 mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <h4>Input Nilai Ujian Madrasah</h4>
        <button class="btn btn-sm btn-secondary" onclick="backToDashboard()"><i class="bi bi-arrow-left-circle"></i> Kembali ke Dasbor</button>
    </div>
    <hr>
    <div class="card">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 form-group">
                    <label for="tahun-ajaran-select-input">Tahun Ajaran</label>
                    <select id="tahun-ajaran-select-input" class="form-control" onchange="loadMapelForInput()"></select>
                </div>
                <div class="col-md-6 form-group">
                    <label for="mapel-select-input">Mata Pelajaran</label>
                    <select id="mapel-select-input" class="form-control" onchange="updateTampilkanSiswaButtonState()"></select>
                </div>
            </div>
            <button id="tampilkan-siswa-btn" class="btn btn-primary" onclick="loadNilaiTable()" disabled><i class="bi bi-person-lines-fill"></i> Tampilkan Siswa</button>
        </div>
    </div>
    <div class="card mt-4" id="table-card-container" style="display: none;">
      <div class="card-header">Form Input Nilai</div>
      <div class="card-body">
        <div id="table-container" class="mt-2">
          <div class="table-responsive">
            <table class="table table-bordered table-striped">
              <thead class="thead-dark">
                <tr>
                  <th style="width: 50px;">No</th>
                  <th>Nama Siswa</th>
                  <th style="width: 100px;">Nilai</th>
                </tr>
              </thead>
              <tbody id="nilai-table-body"></tbody>
            </table>
          </div>
          <button id="submit-button" class="btn btn-success mt-3" onclick="submitSemuaNilai()"><i class="bi bi-save"></i> Simpan Semua Nilai</button>
          <div id="status" class="mt-3"></div>
        </div>
      </div>
    </div>
    <div id="loading-spinner-table" class="text-center mt-4" style="display: none;">
        <div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>
        <p>Memuat data siswa...</p>
    </div>
  </div>

  <div id="cetak-nilai-view" class="container mt-4 mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <h4>Kirim & Cetak Nilai Ujian Madrasah</h4>
        <button class="btn btn-sm btn-secondary" onclick="backToDashboard()"><i class="bi bi-arrow-left-circle"></i> Kembali ke Dasbor</button>
    </div>
    <hr>
    <div class="card">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 form-group">
                    <label for="tahun-ajaran-select-cetak">Tahun Ajaran</label>
                    <select id="tahun-ajaran-select-cetak" class="form-control" onchange="loadMapelForCetak()"></select>
                </div>
                <div class="col-md-6 form-group">
                    <label for="mapel-select-cetak">Mata Pelajaran</label>
                    <select id="mapel-select-cetak" class="form-control" onchange="updatePreviewButtonState()"></select>
                </div>
            </div>
            <button id="tampilkan-preview-btn" class="btn btn-info" onclick="previewCetakNilai()" disabled><i class="bi bi-eye"></i> Tampilkan Preview</button>
            <hr>
            <div id="preview-container" class="mt-3" style="display:none;">
                <div class="text-center mb-4">
                    <h5>NILAI UJIAN MADRASAH TAHUN <span id="preview-tahun"></span></h5>
                    <h6>TAHUN PELAJARAN <span id="preview-ta-deskripsi"></span></h6>
                </div>
                <table class="table table-sm">
                  <tr><td style="width:150px;"><b>Nama Mata Pelajaran</b></td><td id="preview-mapel"></td></tr>
                  <tr><td><b>Guru Pemeriksa</b></td><td id="preview-guru"></td></tr>
                </table>
                <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="thead-dark">
                            <tr><th>No</th><th>Ruang Ujian</th><th>Nomor Ujian</th><th>Nama Peserta Ujian</th><th>Nilai</th><th>Nilai dengan Huruf</th></tr>
                        </thead>
                        <tbody id="preview-table-body"></tbody>
                    </table>
                </div>
                <div class="row mt-5">
                    <div class="col-6">
                        Mengetahui,<br>Kepala Madrasah,
                        <br><br><br><br>
                        <b id="preview-kepsek"></b><br>
                        NIP. <span id="preview-nip"></span>
                    </div>
                    <div class="col-6 text-right">
                        <span id="preview-tempat-ttd"></span>, <span id="preview-tanggal-ttd"></span><br>
                        Guru Pemeriksa,
                        <br><br><br><br>
                        <b id="preview-guru-ttd"></b><br>
                        NIP. -
                    </div>
                </div>
                <hr>
                <div id="pdf-action-container">
                    <button id="kirim-btn" class="btn btn-success" onclick="kirimStatus()"><i class="bi bi-send-check"></i> Kirim Status & Siapkan PDF</button>
                    <button id="batal-kirim-btn" class="btn btn-warning" style="display: none;" onclick="batalKirim()"><i class="bi bi-x-circle"></i> Batal Kirim</button>
                    <button id="unduh-pdf-btn" class="btn btn-primary" style="display: none;" onclick="unduhPdf()"><i class="bi bi-download"></i> Unduh PDF</button>
                </div>
                <div id="pdf-status" class="mt-2"></div>
            </div>
            <div id="loading-spinner-cetak" class="text-center mt-4" style="display: none;">
                <div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>
                <p>Memuat data preview...</p>
            </div>
        </div>
    </div>
  </div>

  <div id="pengaturan-cetak-view" class="container mt-4 mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <h4>Pengaturan Dokumen Cetak</h4>
        <button class="btn btn-sm btn-secondary" onclick="backToDashboard()"><i class="bi bi-arrow-left-circle"></i> Kembali ke Dasbor</button>
    </div>
    <hr>
    <div class="card col-md-8 mx-auto">
        <div class="card-body">
            <p class="text-muted">Pengaturan ini akan digunakan pada bagian tanda tangan di dokumen PDF yang akan diunduh.</p>
            <div class="form-group">
                <label for="tempat-ttd">Tempat Tanda Tangan</label>
                <input type="text" id="tempat-ttd" class="form-control" placeholder="Contoh: Butung">
            </div>
            <div class="form-group">
                <label for="tanggal-ttd">Tanggal Tanda Tangan</label>
                <input type="date" id="tanggal-ttd" class="form-control">
            </div>
            <button id="simpan-pengaturan-btn" class="btn btn-primary" onclick="simpanPengaturanCetak()"><i class="bi bi-save"></i> Simpan Pengaturan</button>
            <div id="pengaturan-status" class="mt-3"></div>
        </div>
    </div>
  </div>

<script>
    
    let loggedInUser = null;
    let currentMapelRequestID = 0;
    let currentStatusRequestID = 0; // <-- [PERBAIKAN] ID untuk request status
    let cachedTahunAjaran = null;
    let cachedMapel = null;
    let cachedPengaturan = null;
    let statusTimer;
    let cachedMapelWithStatus = null; 

    document.addEventListener("DOMContentLoaded", checkSession);

    function showStatus(elementId, message, type, duration = 5000, isLoading = false) {
        const statusDiv = document.getElementById(elementId);
        if (!statusDiv) return;
        clearTimeout(statusTimer);
        const alertHTML = `<div class="alert alert-${type}">${message}</div>`;
        statusDiv.innerHTML = alertHTML;
        if (!isLoading) {
            statusTimer = setTimeout(() => {
                statusDiv.innerHTML = '';
            }, duration);
        }
    }

    function checkSession() {
        const token = localStorage.getItem('authToken');
        if (token) {
            const localUser = localStorage.getItem('loggedInUser');
            const localMapelStatus = localStorage.getItem('cachedMapelWithStatus');
            const localTA = localStorage.getItem('cachedTahunAjaran');
            const localPengaturan = localStorage.getItem('cachedPengaturan');
            
            if (localUser && localMapelStatus && localTA) {
                loggedInUser = JSON.parse(localUser);
                cachedMapelWithStatus = JSON.parse(localMapelStatus);
                cachedTahunAjaran = JSON.parse(localTA);
                cachedPengaturan = localPengaturan ? JSON.parse(localPengaturan) : {};
                cachedMapel = Object.keys(cachedMapelWithStatus).reduce((acc, taId) => {
                    acc[taId] = cachedMapelWithStatus[taId].map(item => item.mapel);
                    return acc;
                }, {});
                google.script.run.withSuccessHandler(onTokenVerified).verifyToken(token);
                showDashboard();
            } else {
                google.script.run.withSuccessHandler(onTokenVerified).withFailureHandler(forceLogout).verifyToken(token);
            }
        } else {
            showView('login-view', 'flex');
        }
    }
    
    function onTokenVerified(user) {
        if (user) {
            loggedInUser = user;
            localStorage.setItem('loggedInUser', JSON.stringify(user));
            loadInitialData(false);
        } else {
            forceLogout();
        }
    }

    function handleLogin() {
        const credentials = { email: document.getElementById('email').value, password: document.getElementById('password').value };
        document.getElementById('login-button').disabled = true;
        document.getElementById('login-button').innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Memverifikasi...';
        document.getElementById('login-alert').style.display = 'none';
        google.script.run.withSuccessHandler(onLoginSuccess).withFailureHandler(onLoginFailure).userLogin(credentials);
    }

    function onLoginSuccess(user) {
        if (user && user.token) {
            localStorage.setItem('authToken', user.token);
            loggedInUser = user;
            localStorage.setItem('loggedInUser', JSON.stringify(user));
            loadInitialData(true);
        } else {
            onLoginFailure("Email atau password salah.");
        }
    }
    
    function onLoginFailure(error) {
        const button = document.getElementById('login-button');
        const alertBox = document.getElementById('login-alert');
        alertBox.innerText = error.toString();
        alertBox.style.display = 'block';
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-box-arrow-in-right"></i> Login';
    }
    
    function loadInitialData(showDashOnComplete) {
        google.script.run
            .withSuccessHandler(data => {
                if (data.error) {
                    console.error("Gagal memuat data awal:", data.error);
                    forceLogout();
                    return;
                }
                cachedTahunAjaran = data.tahunAjaran;
                cachedMapelWithStatus = data.mapelWithStatus;
                cachedMapel = Object.keys(data.mapelWithStatus).reduce((acc, taId) => {
                    acc[taId] = data.mapelWithStatus[taId].map(item => item.mapel);
                    return acc;
                }, {});
                localStorage.setItem('cachedTahunAjaran', JSON.stringify(cachedTahunAjaran));
                localStorage.setItem('cachedMapelWithStatus', JSON.stringify(cachedMapelWithStatus));
                localStorage.setItem('cachedMapel', JSON.stringify(cachedMapel));
                if (showDashOnComplete) {
                    showDashboard();
                }
            })
            .withFailureHandler(error => {
                console.error("Gagal memuat data awal:", error);
                forceLogout();
            })
            .getInitialDataForGuru(loggedInUser.email);
    }

    function showView(viewId, displayType = 'block') {
        ['loading-view', 'login-view', 'dashboard-view', 'input-nilai-view', 'cetak-nilai-view', 'pengaturan-cetak-view'].forEach(id => {
            document.getElementById(id).style.display = 'none';
        });
        document.getElementById(viewId).style.display = displayType;
    }
    
    function backToDashboard() { 
        showView('dashboard-view');
        fetchDashboardStatus();
    }

    function showDashboard() {
        showView('dashboard-view');
        document.getElementById('welcome-message-dash').innerText = `Halo, ${loggedInUser.nama}`;
        populateTahunAjaran(cachedTahunAjaran, 'status-tahun-ajaran-select', false);
        fetchDashboardStatus();
    }
    
    function populateTahunAjaran(data, selectId, addDefaultOption = false) {
        const select = document.getElementById(selectId);
        select.innerHTML = '';
        if (addDefaultOption) select.innerHTML = '<option value="" selected disabled>-- Pilih --</option>';
        if (data && data.length > 0) {
            data.forEach(item => {
                const lockIcon = item.is_locked ? ' 🔒' : '';
                const option = new Option(item.deskripsi + lockIcon, item.id_tahun_ajaran);
                if (item.is_locked) {
                    option.style.color = '#6c757d';
                }
                select.add(option);
            });
        } else {
            select.innerHTML = '<option value="" selected disabled>Tidak ditemukan</option>';
        }
    }

    function fetchDashboardStatus() {
        // <-- [PERBAIKAN] Logika baru untuk mencegah race condition
        currentStatusRequestID++;
        const thisRequestID = currentStatusRequestID;

        const selectedTahunAjaranId = document.getElementById('status-tahun-ajaran-select').value;
        document.getElementById('status-table-container').style.display = 'none';
        document.getElementById('status-table-error').style.display = 'none';
        document.getElementById('loading-spinner-status').style.display = 'block';

        if (!selectedTahunAjaranId) {
             populateDashboardStatus([]);
             return;
        }
        
        const successCallback = (statusData) => {
            if (thisRequestID === currentStatusRequestID) {
                populateDashboardStatus(statusData);
            }
        };

        const failureCallback = (error) => {
            if (thisRequestID === currentStatusRequestID) {
                onStatusLoadFailure(error);
            }
        };

        google.script.run
            .withSuccessHandler(successCallback)
            .withFailureHandler(failureCallback)
            .getDashboardStatus(loggedInUser.id_sekolah, selectedTahunAjaranId);
    }

    function populateDashboardStatus(statusData) {
        document.getElementById('loading-spinner-status').style.display = 'none';
        if (statusData.error) { onStatusLoadFailure(statusData.error); return; }
        const tableBody = document.getElementById('status-table-body');
        tableBody.innerHTML = ''; 
        if (statusData && statusData.length > 0) {
            statusData.forEach(item => {
                const statusIcon = item.status ? `<span class="text-success font-weight-bold">✔ Selesai</span>` : `<span class="text-danger">✖ Belum</span>`;
                const actionButton = item.status ? `<button class="btn btn-sm btn-info" onclick="unduhLaporan('${item.email}', '${item.mapel}')"><i class="bi bi-file-earmark-pdf"></i> Unduh</button>` : `<button class="btn btn-sm btn-secondary" disabled><i class="bi bi-file-earmark-pdf"></i> Unduh</button>`;
                const row = `<tr><td>${item.nama}</td><td>${item.mapel}</td><td class="text-center">${statusIcon}</td><td class="text-center">${actionButton}</td></tr>`;
                tableBody.innerHTML += row;
            });
            document.getElementById('status-table-container').style.display = 'block';
        } else {
             const select = document.getElementById('status-tahun-ajaran-select');
             const selectedTADescription = select.options[select.selectedIndex]?.text || 'tahun ajaran ini';
             tableBody.innerHTML = `<tr><td colspan="4" class="text-center">Tidak ada data mata pelajaran untuk ${selectedTADescription}.</td></tr>`;
             document.getElementById('status-table-container').style.display = 'block';
        }
    }

    function onStatusLoadFailure(error) {
        console.error("Gagal memuat status dashboard:", error);
        document.getElementById('loading-spinner-status').style.display = 'none';
        document.getElementById('status-table-error').style.display = 'block';
    }

    function goToInputNilai() {
        showView('input-nilai-view');
        populateTahunAjaran(cachedTahunAjaran, 'tahun-ajaran-select-input', true);
        loadMapelForInput();
        document.getElementById('table-card-container').style.display = 'none';
        document.getElementById('loading-spinner-table').style.display = 'none';
    }

    function loadMapelForInput() {
        const taId = document.getElementById('tahun-ajaran-select-input').value;
        const mapelSelect = document.getElementById('mapel-select-input');
        mapelSelect.innerHTML = '';
        const mapelList = taId && cachedMapel[taId] ? cachedMapel[taId] : [];
        if (mapelList.length > 0) {
            mapelSelect.innerHTML = '<option value="" selected disabled>-- Pilih Mapel --</option>';
            mapelList.forEach(m => mapelSelect.add(new Option(m, m)));
        } else {
            mapelSelect.innerHTML = '<option value="" selected disabled>Pilih Tahun Ajaran</option>';
        }
        document.getElementById('table-card-container').style.display = 'none';
        updateTampilkanSiswaButtonState();
    }

    function updateTampilkanSiswaButtonState() {
        const taId = document.getElementById('tahun-ajaran-select-input').value;
        const mapel = document.getElementById('mapel-select-input').value;
        document.getElementById('tampilkan-siswa-btn').disabled = !(taId && mapel);
    }

    function loadNilaiTable() {
        const idTahunAjaran = document.getElementById('tahun-ajaran-select-input').value;
        const mapel = document.getElementById('mapel-select-input').value;
        if (!idTahunAjaran || !mapel) return;
        currentMapelRequestID++;
        const thisRequestID = currentMapelRequestID;
        document.getElementById('table-card-container').style.display = 'none';
        document.getElementById('loading-spinner-table').style.display = 'block';
        document.getElementById('status').innerHTML = '';
        google.script.run
            .withSuccessHandler(onDataLoaded)
            .getSiswaAndNilai(loggedInUser.id_sekolah, mapel, idTahunAjaran, thisRequestID, loggedInUser.email);
    }

    function onDataLoaded(response) {
        if (response.requestID !== currentMapelRequestID) return;
        const tableBody = document.getElementById('nilai-table-body');
        tableBody.innerHTML = ''; 
        const data = response.siswaData; 
        if (data && data.length > 0) {
            data.forEach((item, index) => {
                const nilaiTampil = (item.nilai !== null && item.nilai !== undefined) ? item.nilai : '';
                const row = `<tr>
                                <td>${index + 1}</td>
                                <td>${item.nama}</td>
                                <td><input type="number" class="form-control nilai-input" 
                                           value="${nilaiTampil}" 
                                           min="0" max="100" inputmode="numeric" 
                                           oninput="this.value = this.value > 100 ? 100 : this.value < 0 ? 0 : this.value" 
                                           data-nomor-ujian="${item.nomor_ujian}" 
                                           data-original-nilai="${nilaiTampil}"></td>
                             </tr>`;
                tableBody.innerHTML += row;
            });
        } else {
            tableBody.innerHTML = '<tr><td colspan="3" class="text-center">Data siswa tidak ditemukan.</td></tr>';
        }
        document.getElementById('loading-spinner-table').style.display = 'none';
        document.getElementById('table-card-container').style.display = 'block';

        const submitButton = document.getElementById('submit-button');
        const statusDiv = document.getElementById('status');
        const allInputs = document.querySelectorAll('#nilai-table-body .nilai-input');
        
        if (response.isTahunAjaranLocked) {
            submitButton.disabled = true;
            allInputs.forEach(input => {
                input.disabled = true;
            });
            const msg = `<strong>Tahun Ajaran Terkunci.</strong> Anda tidak dapat lagi mengubah nilai untuk tahun ajaran ini.`;
            showStatus('status', msg, 'warning', 15000);
        } else if (response.isSudahKirim) {
            submitButton.disabled = true;
            allInputs.forEach(input => {
                input.disabled = true;
            });
            const msg = `<strong>Nilai Terkunci.</strong> Data nilai untuk mata pelajaran ini sudah dikirim. Untuk mengubah, silakan batalkan status pengiriman di menu "Kirim dan Cetak Nilai UM" terlebih dahulu.`;
            showStatus('status', msg, 'warning', 15000); 
        } else {
            submitButton.disabled = false;
            allInputs.forEach(input => {
                input.disabled = false;
            });
            statusDiv.innerHTML = ''; 
        }
    }

    function submitSemuaNilai() {
        const button = document.getElementById('submit-button');
        const inputs = document.querySelectorAll('#nilai-table-body .nilai-input');
        const dataToSave = [];
        let hasError = false;
        inputs.forEach(input => {
            input.classList.remove('is-invalid');
            const nilai = parseFloat(input.value);
            if (input.value !== '' && (isNaN(nilai) || nilai < 0 || nilai > 100)) {
                input.classList.add('is-invalid'); hasError = true;
            }
            if (input.value !== input.getAttribute('data-original-nilai')) {
                dataToSave.push({ nomorUjian: input.getAttribute('data-nomor-ujian'), nilai: input.value });
            }
        });
        if (hasError) { 
            showStatus('status', 'Terdapat nilai yang tidak valid (0-100).', 'danger');
            return; 
        }
        if (dataToSave.length === 0) { 
            showStatus('status', 'Tidak ada perubahan data untuk disimpan.', 'info');
            return; 
        }
        const dataLengkap = dataToSave.map(item => ({
          ...item,
          mapel: document.getElementById('mapel-select-input').value,
          emailGuru: loggedInUser.email,
          id_tahun_ajaran: document.getElementById('tahun-ajaran-select-input').value
        }));
        button.disabled = true;
        // <-- [PERBAIKAN] Pesan loading dengan spinner
        const msg = `<div class="d-flex align-items-center"><div class="spinner-border spinner-border-sm mr-2" role="status"></div><span>Menyimpan ${dataLengkap.length} data perubahan...</span></div>`;
        showStatus('status', msg, 'info', 0, true);
        google.script.run.withSuccessHandler(onSaveSuccess).simpanAtauUpdateNilai(dataLengkap);
    }
    
    function onSaveSuccess(response) {
        const button = document.getElementById('submit-button');
        if (response.startsWith("Sukses")) {
            showStatus('status', response, 'success');
            document.querySelectorAll('#nilai-table-body .nilai-input').forEach(input => {
                input.setAttribute('data-original-nilai', input.value);
            });
        } else {
            showStatus('status', response, 'danger');
        }
        button.disabled = false;
    }

    function goToCetakNilai() {
        showView('cetak-nilai-view');
        populateTahunAjaran(cachedTahunAjaran, 'tahun-ajaran-select-cetak', true);
        loadMapelForCetak();
        document.getElementById('preview-container').style.display = 'none';
        document.getElementById('loading-spinner-cetak').style.display = 'none';
    }
    
    function loadMapelForCetak(refreshOnly = false) {
        const taId = document.getElementById('tahun-ajaran-select-cetak').value;
        const mapelSelect = document.getElementById('mapel-select-cetak');
        
        if (!refreshOnly) {
            document.getElementById('preview-container').style.display = 'none';
        }
        
        const mapelData = taId && cachedMapelWithStatus[taId] ? cachedMapelWithStatus[taId] : [];
        
        populateMapelForCetak(mapelData);
        updatePreviewButtonState();
    }
    
    function populateMapelForCetak(mapelData) {
        const mapelSelect = document.getElementById('mapel-select-cetak');
        const selectedValue = mapelSelect.value;
        mapelSelect.innerHTML = ''; 
        
        if (mapelData && mapelData.length > 0) {
            mapelSelect.innerHTML = '<option value="" selected disabled>-- Pilih Mapel --</option>';
            mapelData.forEach(item => {
                const icon = item.status ? '✔' : '✖';
                const displayText = `${icon} ${item.mapel}`;
                const option = new Option(displayText, item.mapel);
                if (item.status) {
                    option.style.color = 'green';
                    option.style.fontWeight = 'bold';
                } else {
                    option.style.color = 'red';
                }
                mapelSelect.add(option);
            });
            if (Array.from(mapelSelect.options).some(opt => opt.value === selectedValue)) {
                mapelSelect.value = selectedValue;
            }
        } else {
            mapelSelect.innerHTML = '<option value="" selected disabled>Mapel tidak ditemukan</option>';
        }
    }

    function updatePreviewButtonState() {
        const taId = document.getElementById('tahun-ajaran-select-cetak').value;
        const mapel = document.getElementById('mapel-select-cetak').value;
        document.getElementById('tampilkan-preview-btn').disabled = !(taId && mapel);
    }

    function previewCetakNilai() {
        const taSelect = document.getElementById('tahun-ajaran-select-cetak');
        const mapelSelect = document.getElementById('mapel-select-cetak');
        if (!taSelect.value || !mapelSelect.value) return;
        document.getElementById('preview-container').style.display = 'none';
        document.getElementById('loading-spinner-cetak').style.display = 'block';
        const data = {
            id_sekolah: loggedInUser.id_sekolah,
            id_tahun_ajaran: taSelect.value,
            deskripsi_ta: taSelect.options[taSelect.selectedIndex].text.replace(' 🔒', ''),
            nama_mapel: mapelSelect.value,
            email_guru: loggedInUser.email,
        };
        google.script.run.withSuccessHandler(onPreviewDataLoaded).getCetakData(data);
    }
    
    function onPreviewDataLoaded(data) {
        document.getElementById('loading-spinner-cetak').style.display = 'none';
        if (data.error) { alert('Gagal memuat data: ' + data.error); return; }
        document.getElementById('preview-container').style.display = 'block';
        
        const tahunAjaranParts = data.deskripsi_ta.split('/');
        const tahunLulus = tahunAjaranParts.length > 1 ? tahunAjaranParts[1] : new Date().getFullYear();
        document.getElementById('preview-tahun').innerText = tahunLulus;
        document.getElementById('preview-ta-deskripsi').innerText = data.deskripsi_ta;
        document.getElementById('preview-mapel').innerText = `: ${data.nama_mapel}`;
        document.getElementById('preview-guru').innerText = `: ${data.guru.nama}`;
        const tableBody = document.getElementById('preview-table-body');
        tableBody.innerHTML = '';
        if (data.nilai_siswa.length > 0) {
            data.nilai_siswa.forEach((item, index) => {
                const row = `<tr><td>${index + 1}</td><td>${item.ruang_ujian}</td><td>${item.nomor_ujian}</td><td>${item.nama}</td><td>${item.nilai}</td><td>${item.nilai_huruf}</td></tr>`;
                tableBody.innerHTML += row;
            });
        } else {
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Data nilai tidak ditemukan.</td></tr>';
        }
        document.getElementById('preview-kepsek').innerText = data.sekolah.kepala_sekolah;
        document.getElementById('preview-nip').innerText = data.sekolah.nip_kepsek || '-';
        document.getElementById('preview-guru-ttd').innerText = data.guru.nama;
        document.getElementById('preview-tempat-ttd').innerText = data.pengaturan.tempat || '______';
        document.getElementById('preview-tanggal-ttd').innerText = data.pengaturan.tanggalFormatted || '______';
        
        const kirimBtn = document.getElementById('kirim-btn');
        const batalKirimBtn = document.getElementById('batal-kirim-btn');
        const unduhPdfBtn = document.getElementById('unduh-pdf-btn');
        
        document.getElementById('pdf-status').innerHTML = '';

        if (data.isTahunAjaranLocked) {
            showStatus('pdf-status', '<strong>Tahun Ajaran Terkunci.</strong> Status pengiriman tidak dapat diubah lagi.', 'warning', 15000);
            kirimBtn.style.display = 'inline-block';
            kirimBtn.disabled = true;
            batalKirimBtn.style.display = 'none';
            unduhPdfBtn.style.display = data.isSudahKirim ? 'inline-block' : 'none';
            unduhPdfBtn.disabled = !data.isSudahKirim;
        } else if (data.isSudahKirim) {
            kirimBtn.style.display = 'none';
            batalKirimBtn.style.display = 'inline-block';
            unduhPdfBtn.style.display = 'inline-block';
            batalKirimBtn.disabled = false;
            unduhPdfBtn.disabled = false;
        } else {
            kirimBtn.style.display = 'inline-block';
            kirimBtn.disabled = false;
            batalKirimBtn.style.display = 'none';
            unduhPdfBtn.style.display = 'none';
        }
    }
    
    function downloadFromBase64(base64Data, fileName) {
        const byteCharacters = atob(base64Data);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], {type: 'application/pdf'});

        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function kirimStatus() {
        const kirimBtn = document.getElementById('kirim-btn');
        kirimBtn.disabled = true;
        const msg = `<div class="d-flex align-items-center"><div class="spinner-border spinner-border-sm mr-2" role="status"></div><span>Mengirim status penyelesaian...</span></div>`;
        showStatus('pdf-status', msg, 'info', 0, true);
        
        const dataKirim = {
            id_tahun_ajaran: document.getElementById('tahun-ajaran-select-cetak').value,
            nama_mapel: document.getElementById('mapel-select-cetak').value,
            email_guru: loggedInUser.email,
        };
        google.script.run.withSuccessHandler(onStatusSent).withFailureHandler(onPdfError).kirimStatusNilai(dataKirim);
    }

    function onStatusSent(response) {
      if (response.success) {
        showStatus('pdf-status', 'Status berhasil terkirim. Tombol Unduh PDF sekarang tersedia.', 'success');
        
        document.getElementById('kirim-btn').style.display = 'none';
        document.getElementById('batal-kirim-btn').style.display = 'inline-block';
        document.getElementById('unduh-pdf-btn').style.display = 'inline-block';
        document.getElementById('batal-kirim-btn').disabled = false;
        document.getElementById('unduh-pdf-btn').disabled = false;
        
        const taId = document.getElementById('tahun-ajaran-select-cetak').value;
        const mapel = document.getElementById('mapel-select-cetak').value;
        if (cachedMapelWithStatus && cachedMapelWithStatus[taId]) {
            const mapelEntry = cachedMapelWithStatus[taId].find(m => m.mapel === mapel);
            if (mapelEntry) {
                mapelEntry.status = true;
                localStorage.setItem('cachedMapelWithStatus', JSON.stringify(cachedMapelWithStatus));
            }
        }
        loadMapelForCetak(true);
        fetchDashboardStatus();

      } else {
        onPdfError({toString: () => response.error});
      }
    }

    function batalKirim() {
        const batalBtn = document.getElementById('batal-kirim-btn');
        batalBtn.disabled = true;
        const msg = `<div class="d-flex align-items-center"><div class="spinner-border spinner-border-sm mr-2" role="status"></div><span>Membatalkan status...</span></div>`;
        showStatus('pdf-status', msg, 'info', 0, true);
        const dataBatal = {
            id_tahun_ajaran: document.getElementById('tahun-ajaran-select-cetak').value,
            nama_mapel: document.getElementById('mapel-select-cetak').value,
            email_guru: loggedInUser.email,
        };
        google.script.run.withSuccessHandler(onBatalSuccess).withFailureHandler(onBatalError).batalKirimStatusNilai(dataBatal);
    }

    function onBatalSuccess(response) {
        if(response.success){
            document.getElementById('kirim-btn').style.display = 'inline-block';
            document.getElementById('kirim-btn').disabled = false;
            document.getElementById('batal-kirim-btn').style.display = 'none';
            document.getElementById('unduh-pdf-btn').style.display = 'none';
            showStatus('pdf-status', 'Status pengiriman telah dibatalkan.', 'warning');
            
            const taId = document.getElementById('tahun-ajaran-select-cetak').value;
            const mapel = document.getElementById('mapel-select-cetak').value;
            if (cachedMapelWithStatus && cachedMapelWithStatus[taId]) {
                const mapelEntry = cachedMapelWithStatus[taId].find(m => m.mapel === mapel);
                if (mapelEntry) {
                    mapelEntry.status = false;
                    localStorage.setItem('cachedMapelWithStatus', JSON.stringify(cachedMapelWithStatus));
                }
            }
            loadMapelForCetak(true);
            fetchDashboardStatus();
        } else {
            onBatalError({toString: () => response.error});
        }
    }

    function onBatalError(error) {
        document.getElementById('batal-kirim-btn').disabled = false;
        showStatus('pdf-status', `Gagal membatalkan status: ${error.toString()}`, 'danger');
    }

    function unduhPdf() {
        const unduhBtn = document.getElementById('unduh-pdf-btn');
        unduhBtn.disabled = true;
        const msg = `<div class="d-flex align-items-center"><div class="spinner-border spinner-border-sm mr-2" role="status"></div><span>Membuat file PDF, mohon tunggu...</span></div>`;
        showStatus('pdf-status', msg, 'info', 0, true);
        
        const dataPdf = {
            id_sekolah: loggedInUser.id_sekolah,
            id_tahun_ajaran: document.getElementById('tahun-ajaran-select-cetak').value,
            nama_mapel: document.getElementById('mapel-select-cetak').value,
            email_guru: loggedInUser.email
        };
        google.script.run.withSuccessHandler(onPdfDataReceived).withFailureHandler(onPdfError).generatePdfAsBase64(dataPdf);
    }
    
    function onPdfDataReceived(response) {
        const unduhBtn = document.getElementById('unduh-pdf-btn');
        if (response.base64Data) {
            showStatus('pdf-status', 'PDF berhasil dibuat! Unduhan akan dimulai secara otomatis.', 'success');
            downloadFromBase64(response.base64Data, response.fileName);
        } else {
            onPdfError({toString: () => response.error});
        }
        unduhBtn.disabled = false;
    }

    function onPdfError(error) {
        const kirimBtn = document.getElementById('kirim-btn');
        const unduhBtn = document.getElementById('unduh-pdf-btn');
        
        kirimBtn.disabled = false;
        unduhBtn.disabled = false;

        showStatus('pdf-status', `Terjadi kesalahan: ${error.toString()}`, 'danger');
    }

    function unduhLaporan(emailGuru, namaMapel) {
        $('#loadingModal').modal('show');
        const statusTASelect = document.getElementById('status-tahun-ajaran-select');
        const dataPdf = {
            id_sekolah: loggedInUser.id_sekolah,
            id_tahun_ajaran: statusTASelect.value,
            nama_mapel: namaMapel,
            email_guru: emailGuru
        };
        google.script.run.withSuccessHandler(onPdfDataReceivedFromDashboard).withFailureHandler(onDashboardPdfError).generatePdfAsBase64(dataPdf);
    }
    
    function onPdfDataReceivedFromDashboard(response) {
        if (response.base64Data) {
            downloadFromBase64(response.base64Data, response.fileName);
        } else {
            alert("Gagal membuat PDF: " + (response.error || "Kesalahan tidak diketahui."));
        }
        $('#loadingModal').modal('hide');
    }

    function onDashboardPdfError(error) {
        alert("Gagal membuat PDF: " + error.toString());
        $('#loadingModal').modal('hide');
    }
    
    function goToPengaturanCetak() {
        showView('pengaturan-cetak-view');
        document.getElementById('pengaturan-status').innerHTML = '';
        const tempatInput = document.getElementById('tempat-ttd');
        const tanggalInput = document.getElementById('tanggal-ttd');
        const simpanBtn = document.getElementById('simpan-pengaturan-btn');
        tempatInput.value = '';
        tempatInput.placeholder = 'Memuat data...';
        tanggalInput.value = '';
        tempatInput.disabled = true;
        tanggalInput.disabled = true;
        simpanBtn.disabled = true;
        google.script.run.withSuccessHandler(onPengaturanLoaded).getPengaturanCetak(loggedInUser.email);
    }

    function onPengaturanLoaded(pengaturan) {
        cachedPengaturan = pengaturan;
        localStorage.setItem('cachedPengaturan', JSON.stringify(pengaturan));
        const tempatInput = document.getElementById('tempat-ttd');
        const tanggalInput = document.getElementById('tanggal-ttd');
        const simpanBtn = document.getElementById('simpan-pengaturan-btn');
        tempatInput.placeholder = 'Contoh: Butung';
        tempatInput.disabled = false;
        tanggalInput.disabled = false;
        simpanBtn.disabled = false;
        tempatInput.value = pengaturan.tempat || '';
        tanggalInput.value = pengaturan.tanggal || '';
    }

    function simpanPengaturanCetak() {
        const tempat = document.getElementById('tempat-ttd').value;
        const tanggal = document.getElementById('tanggal-ttd').value;
        const button = document.getElementById('simpan-pengaturan-btn');
        showStatus('pengaturan-status', 'Menyimpan...', 'info', 0, true);
        button.disabled = true;
        const pengaturan = { email: loggedInUser.email, tempat: tempat, tanggal: tanggal };
        google.script.run.withSuccessHandler(onPengaturanSaved).withFailureHandler(onPengaturanSaveFailed).savePengaturanCetak(pengaturan);
    }

    function onPengaturanSaved(response) {
        document.getElementById('simpan-pengaturan-btn').disabled = false;
        if(response.success) {
            showStatus('pengaturan-status', 'Pengaturan berhasil disimpan.', 'success');
            cachedPengaturan = { tempat: document.getElementById('tempat-ttd').value, tanggal: document.getElementById('tanggal-ttd').value };
            localStorage.setItem('cachedPengaturan', JSON.stringify(cachedPengaturan));
        } else {
            showStatus('pengaturan-status', `Gagal menyimpan: ${response.error}`, 'danger');
        }
    }
    
    function onPengaturanSaveFailed(error) {
        document.getElementById('simpan-pengaturan-btn').disabled = false;
        showStatus('pengaturan-status', `Terjadi kesalahan: ${error.toString()}`, 'danger');
    }
    
    function logout() {
        localStorage.clear();
        forceLogout();
    }

    function forceLogout() {
        loggedInUser = null;
        cachedTahunAjaran = null;
        cachedMapel = null; 
        cachedMapelWithStatus = null;
        cachedPengaturan = null;
        showView('login-view', 'flex');
        document.getElementById('email').value = '';
        document.getElementById('password').value = '';
        const loginButton = document.getElementById('login-button');
        if(loginButton) {
            loginButton.disabled = false;
            loginButton.innerHTML = '<i class="bi bi-box-arrow-in-right"></i> Login';
        }
    }

</script>
</body>
</html>
