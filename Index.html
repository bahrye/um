<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body { background-color: #f8f9fa; }
    .main-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
    #input-nilai-view, #login-view, #dashboard-view, #loading-view { display: none; }
    .nilai-input { width: 80px; text-align: center; }
    .nilai-input.is-invalid {
        border-color: #dc3545; /* Warna merah bootstrap untuk error */
    }
  </style>
</head>
<body>

  <div id="loading-view" class="main-container" style="display: flex;">
    <div class="text-center">
        <div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>
        <p class="mt-2">Memverifikasi sesi...</p>
    </div>
  </div>

  <div id="login-view" class="main-container">
    <div class="col-md-5 col-lg-4 col-sm-10">
      <div class="card shadow-sm">
        <div class="card-body p-4">
          <h3 class="text-center mb-1">Aplikasi Input Nilai</h3>
          <p class="text-center text-muted mb-4">Silakan login untuk melanjutkan</p>
          <div id="login-alert" class="alert alert-danger" style="display: none;"></div>
          <form onsubmit="event.preventDefault(); handleLogin();">
            <div class="form-group">
              <label for="email">Email</label>
              <input type="email" id="email" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="password">Password</label>
              <input type="password" id="password" class="form-control" required>
            </div>
            <button id="login-button" type="submit" class="btn btn-primary btn-block">Login</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div id="dashboard-view" class="container mt-4 mb-4">
     <div class="d-flex justify-content-between align-items-center">
        <h4 id="welcome-message-dash">Selamat Datang!</h4>
        <button class="btn btn-sm btn-outline-danger" onclick="logout()">Logout</button>
    </div>
    <hr>
    <div class="card col-md-8 mx-auto">
        <div class="card-body">
            <h5 class="card-title">Pilih Tahun Ajaran</h5>
            <p class="card-text">Silakan pilih tahun ajaran untuk memulai menginput atau mengedit nilai.</p>
            <div class="form-group">
                <label for="tahun-ajaran-select">Tahun Ajaran</label>
                <select id="tahun-ajaran-select" class="form-control"></select>
            </div>
            <button class="btn btn-primary" onclick="goToInputNilai()">Lanjutkan ke Input Nilai</button>
        </div>
    </div>
  </div>

  <div id="input-nilai-view" class="container mt-4 mb-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
        <div>
            <h4 id="welcome-message-input">Halo Guru!</h4>
            <p class="text-muted mb-0" id="tahun-ajaran-info">Tahun Ajaran: </p>
        </div>
        <div class="mt-2 mt-md-0">
            <button class="btn btn-sm btn-secondary mr-2" onclick="backToDashboard()">Kembali ke Dasbor</button>
            <button class="btn btn-sm btn-outline-danger" onclick="logout()">Logout</button>
        </div>
    </div>
    <hr>
    <div class="card">
      <div class="card-header">Form Input Nilai</div>
      <div class="card-body">
        <div class="form-group row">
          <label for="mapel-select" class="col-sm-3 col-form-label">Pilih Mata Pelajaran:</label>
          <div class="col-sm-9">
            <select id="mapel-select" class="form-control" onchange="loadNilaiTable()"></select>
          </div>
        </div>
        
        <div id="table-container" class="mt-4" style="display: none;">
          <div class="table-responsive">
            <table class="table table-bordered table-striped">
              <thead class="thead-dark">
                <tr>
                  <th style="width: 50px;">No</th>
                  <th>Nama Siswa</th>
                  <th style="width: 100px;">Nilai</th>
                </tr>
              </thead>
              <tbody id="nilai-table-body"></tbody>
            </table>
          </div>
          <button id="submit-button" class="btn btn-success mt-3" onclick="submitSemuaNilai()">Simpan Semua Nilai</button>
          <div id="status" class="mt-3"></div>
        </div>
        <div id="loading-spinner-table" class="text-center mt-4" style="display: none;">
            <div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>
            <p>Memuat data siswa...</p>
        </div>
      </div>
    </div>
  </div>

<script>
    let loggedInUser = null;
    let selectedTahunAjaran = null;

    // --- BLOK FUNGSI LOGIN & SESI ---
    document.addEventListener("DOMContentLoaded", function() { checkSession(); });

    function checkSession() {
        const token = localStorage.getItem('authToken');
        if (token) {
            google.script.run.withSuccessHandler(onTokenVerified).withFailureHandler(forceLogout).verifyToken(token);
        } else {
            showView('login-view', 'flex');
        }
    }
    
    function onTokenVerified(user) {
        if (user) {
            loggedInUser = user;
            showDashboard();
        } else {
            forceLogout();
        }
    }

    function handleLogin() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const button = document.getElementById('login-button');
        const alertBox = document.getElementById('login-alert');

        button.disabled = true;
        button.innerText = 'Memverifikasi...';
        alertBox.style.display = 'none';

        const credentials = { email: email, password: password };
        google.script.run.withSuccessHandler(onLoginSuccess).withFailureHandler(onLoginFailure).userLogin(credentials);
    }

    function onLoginSuccess(user) {
        if (user && user.token) {
            localStorage.setItem('authToken', user.token);
            loggedInUser = user;
            showDashboard();
        } else {
            onLoginFailure("Email atau password salah.");
        }
    }

    // --- BLOK FUNGSI NAVIGASI & TAMPILAN ---
    function showView(viewId, displayType = 'block') {
        ['loading-view', 'login-view', 'dashboard-view', 'input-nilai-view'].forEach(id => {
            const el = document.getElementById(id);
            if(id === 'input-nilai-view' || id === 'dashboard-view') {
                 // Untuk container, gunakan 'block' agar tidak memengaruhi layout internal
                 el.style.display = 'none';
            } else {
                 el.style.display = 'none';
            }
        });
        document.getElementById(viewId).style.display = displayType;
    }

    function showDashboard() {
        showView('dashboard-view');
        document.getElementById('welcome-message-dash').innerText = `Halo, ${loggedInUser.nama}`;
        google.script.run.withSuccessHandler(populateTahunAjaran).getTahunAjaran();
    }
    
    function populateTahunAjaran(data) {
        const select = document.getElementById('tahun-ajaran-select');
        select.innerHTML = '<option value="" selected disabled>-- Pilih --</option>';
        data.forEach(item => {
            select.add(new Option(item.deskripsi, item.id_tahun_ajaran));
        });
    }

    function goToInputNilai() {
        const taSelect = document.getElementById('tahun-ajaran-select');
        if (!taSelect.value) {
            alert('Silakan pilih tahun ajaran terlebih dahulu.');
            return;
        }
        selectedTahunAjaran = {
            id: taSelect.value,
            deskripsi: taSelect.options[taSelect.selectedIndex].text
        };
        showView('input-nilai-view');
        document.getElementById('welcome-message-input').innerText = `Halo, ${loggedInUser.nama}`;
        document.getElementById('tahun-ajaran-info').innerText = `Tahun Ajaran: ${selectedTahunAjaran.deskripsi}`;

        const mapelSelect = document.getElementById('mapel-select');
        mapelSelect.innerHTML = '<option value="" selected disabled>-- Pilih Mapel --</option>';
        loggedInUser.mapel.forEach(m => mapelSelect.add(new Option(m, m)));

        document.getElementById('table-container').style.display = 'none';
        document.getElementById('status').innerHTML = '';
    }

    function backToDashboard() {
        showDashboard();
    }

    // --- BLOK FUNGSI INPUT NILAI ---
    function loadNilaiTable() {
        const mapel = document.getElementById('mapel-select').value;
        if (!mapel) return;

        document.getElementById('table-container').style.display = 'none';
        document.getElementById('loading-spinner-table').style.display = 'block';
        document.getElementById('status').innerHTML = '';

        google.script.run.withSuccessHandler(onDataLoaded).getSiswaAndNilai(loggedInUser.id_sekolah, mapel, selectedTahunAjaran.id);
    }

    function onDataLoaded(data) {
        const tableBody = document.getElementById('nilai-table-body');
        tableBody.innerHTML = ''; 
        if (data && data.length > 0) {
            data.forEach((item, index) => {
                const row = `<tr><td>${index + 1}</td><td>${item.nama}</td><td><input type="number" class="form-control nilai-input" value="${item.nilai}" min="0" max="100" inputmode="numeric" pattern="[0-9]*" oninput="this.value = this.value > 100 ? 100 : this.value < 0 ? 0 : this.value" data-nomor-ujian="${item.nomor_ujian}"></td></tr>`;
                tableBody.innerHTML += row;
            });
        } else {
            tableBody.innerHTML = '<tr><td colspan="3" class="text-center">Data siswa untuk tahun ajaran ini tidak ditemukan.</td></tr>';
        }
        document.getElementById('loading-spinner-table').style.display = 'none';
        document.getElementById('table-container').style.display = 'block';
    }
    
    function submitSemuaNilai() {
        const button = document.getElementById('submit-button');
        const statusDiv = document.getElementById('status');
        const inputs = document.querySelectorAll('.nilai-input');
        const dataToSave = [];
        let adaError = false;

        inputs.forEach(input => {
            input.classList.remove('is-invalid');
        });

        inputs.forEach(input => {
            const nilai = parseFloat(input.value);

            if (input.value !== '' && (isNaN(nilai) || nilai < 0 || nilai > 100)) {
                input.classList.add('is-invalid');
                adaError = true;
            }

            // PERBAIKAN UTAMA DI SINI: Mengambil nomor ujian langsung dari atribut data
            dataToSave.push({
                nomorUjian: input.getAttribute('data-nomor-ujian'),
                nilai: input.value
            });
        });

        if (adaError) {
            statusDiv.innerHTML = `<div class="alert alert-danger">Terdapat nilai yang tidak valid (harus antara 0-100). Silakan perbaiki yang ditandai merah.</div>`;
            return;
        }

        if (dataToSave.length === 0) {
            statusDiv.innerHTML = `<div class="alert alert-warning">Tidak ada data siswa untuk disimpan.</div>`;
            return;
        }
        
        // Filter data yang hanya akan disimpan jika nilainya diisi
        const nilaiYangAkanDisimpan = dataToSave.filter(item => item.nilai !== '' && item.nilai !== null);

        if (nilaiYangAkanDisimpan.length === 0) {
            statusDiv.innerHTML = `<div class="alert alert-info">Tidak ada nilai baru untuk disimpan.</div>`;
            return;
        }
        
        // Tambahkan info mapel, guru, dan tahun ajaran ke array yang akan dikirim
        const dataLengkap = nilaiYangAkanDisimpan.map(item => ({
          ...item,
          mapel: document.getElementById('mapel-select').value,
          emailGuru: loggedInUser.email,
          id_tahun_ajaran: selectedTahunAjaran.id
        }));


        button.disabled = true;
        statusDiv.innerHTML = `<div class="alert alert-info">Menyimpan...</div>`;
        // Kirim data yang sudah lengkap ke server
        google.script.run.withSuccessHandler(onSaveSuccess).simpanAtauUpdateNilai(dataLengkap);
    }
    
    function onSaveSuccess(response) {
        const button = document.getElementById('submit-button');
        const statusDiv = document.getElementById('status');
        if (response.startsWith("Sukses")) {
            statusDiv.innerHTML = `<div class="alert alert-success">${response}</div>`;
        } else {
            statusDiv.innerHTML = `<div class="alert alert-danger">${response}</div>`;
        }
        button.disabled = false;
    }

    // --- BLOK FUNGSI UTILITAS ---
    function logout() {
        localStorage.removeItem('authToken');
        forceLogout();
    }

    function forceLogout() {
        loggedInUser = null;
        selectedTahunAjaran = null;
        showView('login-view', 'flex');
        
        const loginButton = document.getElementById('login-button');
        document.getElementById('email').value = '';
        document.getElementById('password').value = '';
        if(loginButton) {
            loginButton.disabled = false;
            loginButton.innerText = 'Login';
        }
    }

    function onLoginFailure(error) {
        const button = document.getElementById('login-button');
        const alertBox = document.getElementById('login-alert');
        alertBox.innerText = error.toString();
        alertBox.style.display = 'block';
        button.disabled = false;
        button.innerText = 'Login';
    }
</script>
</body>
</html>
