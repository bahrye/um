<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  
  <style>
    body { 
      background-color: #f8f9fa; 
    }
    .main-container { 
      min-height: 100vh; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
    }
    #input-nilai-view, #login-view, #dashboard-view, #loading-view, 
    #cetak-nilai-view, #pengaturan-cetak-view { 
      display: none; 
    }
    .nilai-input { 
      width: 80px; 
      text-align: center; 
    }
    .nilai-input.is-invalid {
        border-color: #dc3545;
    }
    .clickable-card {
        cursor: pointer;
        transition: transform 0.2s;
    }
    .clickable-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

  <div id="loading-view" class="main-container" style="display: flex;">
    <div class="text-center">
        <div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>
        <p class="mt-2">Memverifikasi sesi...</p>
    </div>
  </div>

  <div id="login-view" class="main-container">
    <div class="col-md-5 col-lg-4 col-sm-10">
      <div class="card shadow-sm">
        <div class="card-body p-4">
          <h3 class="text-center mb-1">Aplikasi Input Nilai</h3>
          <p class="text-center text-muted mb-4">Silakan login untuk melanjutkan</p>
          <div id="login-alert" class="alert alert-danger" style="display: none;"></div>
          <form onsubmit="event.preventDefault(); handleLogin();">
            <div class="form-group">
              <label for="email">Email</label>
              <input type="email" id="email" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="password">Password</label>
              <input type="password" id="password" class="form-control" required>
            </div>
            <button id="login-button" type="submit" class="btn btn-primary btn-block">Login</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div id="dashboard-view" class="container mt-4 mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 id="welcome-message-dash">Selamat Datang!</h4>
        <button class="btn btn-sm btn-outline-danger" onclick="logout()">Logout</button>
    </div>
    <div class="card mb-4">
        <div class="card-header">
            Pengumuman
        </div>
        <div class="card-body">
            <p class="card-text">Selamat datang di aplikasi Ujian Madrasah. Silakan pilih salah satu menu di bawah ini untuk memulai. Pastikan data yang Anda masukkan sudah benar sebelum disimpan.</p>
        </div>
    </div>
    <div class="row text-center">
        <div class="col-md-4 mb-3">
            <div class="card clickable-card h-100" onclick="goToInputNilai()">
                <div class="card-body">
                    <h5 class="card-title">Input Nilai UM</h5>
                    <p class="card-text text-muted">Masuk untuk mengisi atau mengubah nilai siswa berdasarkan tahun ajaran.</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card clickable-card h-100" onclick="goToCetakNilai()">
                <div class="card-body">
                    <h5 class="card-title">Kirim dan Cetak Nilai UM</h5>
                    <p class="card-text text-muted">Pilih tahun ajaran dan mapel untuk mencetak laporan nilai akhir.</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card clickable-card h-100" onclick="goToPengaturanCetak()">
                <div class="card-body">
                    <h5 class="card-title">Pengaturan Cetak</h5>
                    <p class="card-text text-muted">Atur informasi tempat dan tanggal untuk tanda tangan pada laporan.</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            Status Input Nilai Guru
            <div class="col-md-5 col-lg-4">
                <select id="status-tahun-ajaran-select" class="form-control form-control-sm" onchange="fetchDashboardStatus()">
                </select>
            </div>
        </div>
        <div class="card-body">
            <div id="loading-spinner-status" class="text-center">
                <div class="spinner-border spinner-border-sm" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <p class="mt-1">Memuat status...</p>
            </div>
            <div id="status-table-container" class="table-responsive" style="display: none;">
                <table class="table table-striped table-bordered">
                    <thead class="thead-light">
                        <tr>
                            <th>Nama Guru</th>
                            <th>Mata Pelajaran</th>
                            <th class="text-center" style="width: 120px;">Status</th>
                            <th class="text-center" style="width: 150px;">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="status-table-body">
                    </tbody>
                </table>
            </div>
             <div id="status-table-error" class="text-center text-muted" style="display: none;">
                Gagal memuat data status. Silakan coba lagi nanti.
            </div>
        </div>
    </div>
    
  </div>

  <div id="input-nilai-view" class="container mt-4 mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <h4>Input Nilai Ujian Madrasah</h4>
        <button class="btn btn-sm btn-secondary" onclick="backToDashboard()">Kembali ke Dasbor</button>
    </div>
    <hr>
    <div class="card">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 form-group">
                    <label for="tahun-ajaran-select-input">Tahun Ajaran</label>
                    <select id="tahun-ajaran-select-input" class="form-control" onchange="loadMapelForInput()"></select>
                </div>
                <div class="col-md-6 form-group">
                    <label for="mapel-select-input">Mata Pelajaran</label>
                    <select id="mapel-select-input" class="form-control" onchange="updateTampilkanSiswaButtonState()"></select>
                </div>
            </div>
            <button id="tampilkan-siswa-btn" class="btn btn-primary" onclick="loadNilaiTable()" disabled>Tampilkan Siswa</button>
        </div>
    </div>
    <div class="card mt-4" id="table-card-container" style="display: none;">
      <div class="card-header">Form Input Nilai</div>
      <div class="card-body">
        <div id="table-container" class="mt-2">
          <div class="table-responsive">
            <table class="table table-bordered table-striped">
              <thead class="thead-dark">
                <tr>
                  <th style="width: 50px;">No</th>
                  <th>Nama Siswa</th>
                  <th style="width: 100px;">Nilai</th>
                </tr>
              </thead>
              <tbody id="nilai-table-body"></tbody>
            </table>
          </div>
          <button id="submit-button" class="btn btn-success mt-3" onclick="submitSemuaNilai()">Simpan Semua Nilai</button>
          <div id="status" class="mt-3"></div>
        </div>
      </div>
    </div>
    <div id="loading-spinner-table" class="text-center mt-4" style="display: none;">
        <div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>
        <p>Memuat data siswa...</p>
    </div>
  </div>

  <div id="cetak-nilai-view" class="container mt-4 mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <h4>Cetak Nilai Ujian Madrasah</h4>
        <button class="btn btn-sm btn-secondary" onclick="backToDashboard()">Kembali ke Dasbor</button>
    </div>
    <hr>
    <div class="card">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 form-group">
                    <label for="tahun-ajaran-select-cetak">Tahun Ajaran</label>
                    <select id="tahun-ajaran-select-cetak" class="form-control" onchange="loadMapelForCetak()"></select>
                </div>
                <div class="col-md-6 form-group">
                    <label for="mapel-select-cetak">Mata Pelajaran</label>
                    <select id="mapel-select-cetak" class="form-control" onchange="updatePreviewButtonState()"></select>
                </div>
            </div>
            <button id="tampilkan-preview-btn" class="btn btn-info" onclick="previewCetakNilai()" disabled>Tampilkan Preview</button>
            <hr>
            <div id="preview-container" class="mt-3" style="display:none;">
                <div class="text-center mb-4">
                    <h5>NILAI UJIAN MADRASAH TAHUN <span id="preview-tahun"></span></h5>
                    <h6>TAHUN PELAJARAN <span id="preview-ta-deskripsi"></span></h6>
                </div>
                <table class="table table-sm">
                  <tr><td style="width:150px;"><b>Nama Mata Pelajaran</b></td><td id="preview-mapel"></td></tr>
                  <tr><td><b>Guru Pemeriksa</b></td><td id="preview-guru"></td></tr>
                </table>
                <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="thead-dark">
                            <tr><th>No</th><th>Ruang Ujian</th><th>Nomor Ujian</th><th>Nama Peserta Ujian</th><th>Nilai</th><th>Nilai dengan Huruf</th></tr>
                        </thead>
                        <tbody id="preview-table-body"></tbody>
                    </table>
                </div>
                <div class="row mt-5">
                    <div class="col-6">
                        Mengetahui,<br>Kepala Madrasah,
                        <br><br><br><br>
                        <b id="preview-kepsek"></b><br>
                        NIP. <span id="preview-nip"></span>
                    </div>
                    <div class="col-6 text-right">
                        <span id="preview-tempat-ttd"></span>, <span id="preview-tanggal-ttd"></span><br>
                        Guru Pemeriksa,
                        <br><br><br><br>
                        <b id="preview-guru-ttd"></b><br>
                        NIP. -
                    </div>
                </div>
                <hr>
                <button id="unduh-pdf-btn" class="btn btn-success" onclick="kirimDanUnduhPdf()">Kirim dan Unduh PDF</button>
                <div id="pdf-status" class="mt-2"></div>
            </div>
            <div id="loading-spinner-cetak" class="text-center mt-4" style="display: none;">
                <div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>
                <p>Memuat data preview...</p>
            </div>
        </div>
    </div>
  </div>

  <div id="pengaturan-cetak-view" class="container mt-4 mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <h4>Pengaturan Dokumen Cetak</h4>
        <button class="btn btn-sm btn-secondary" onclick="backToDashboard()">Kembali ke Dasbor</button>
    </div>
    <hr>
    <div class="card col-md-8 mx-auto">
        <div class="card-body">
            <p class="text-muted">Pengaturan ini akan digunakan pada bagian tanda tangan di dokumen PDF yang akan diunduh.</p>
            <div class="form-group">
                <label for="tempat-ttd">Tempat Tanda Tangan</label>
                <input type="text" id="tempat-ttd" class="form-control" placeholder="Contoh: Butung">
            </div>
            <div class="form-group">
                <label for="tanggal-ttd">Tanggal Tanda Tangan</label>
                <input type="date" id="tanggal-ttd" class="form-control">
            </div>
            <button id="simpan-pengaturan-btn" class="btn btn-primary" onclick="simpanPengaturanCetak()">Simpan Pengaturan</button>
            <div id="pengaturan-status" class="mt-3"></div>
        </div>
    </div>
  </div>

<script>
    
    let loggedInUser = null;
    let currentMapelRequestID = 0;
    let cachedTahunAjaran = null;
    let cachedMapel = null;
    let cachedPengaturan = null;

    document.addEventListener("DOMContentLoaded", checkSession);

    function checkSession() {
        const token = localStorage.getItem('authToken');
        if (token) {
            const localUser = localStorage.getItem('loggedInUser');
            const localMapel = localStorage.getItem('cachedMapel');
            const localTA = localStorage.getItem('cachedTahunAjaran');
            const localPengaturan = localStorage.getItem('cachedPengaturan');
            if (localUser && localMapel && localTA) {
                loggedInUser = JSON.parse(localUser);
                cachedMapel = JSON.parse(localMapel);
                cachedTahunAjaran = JSON.parse(localTA);
                cachedPengaturan = localPengaturan ? JSON.parse(localPengaturan) : {};
                google.script.run.withSuccessHandler(onTokenVerified).verifyToken(token);
                showDashboard();
            } else {
                google.script.run.withSuccessHandler(onTokenVerified).withFailureHandler(forceLogout).verifyToken(token);
            }
        } else {
            showView('login-view', 'flex');
        }
    }
    
    function onTokenVerified(user) {
        if (user) {
            loggedInUser = user;
            localStorage.setItem('loggedInUser', JSON.stringify(user));
            loadInitialData(false); 
        } else {
            forceLogout();
        }
    }

    function handleLogin() {
        const credentials = { email: document.getElementById('email').value, password: document.getElementById('password').value };
        document.getElementById('login-button').disabled = true;
        document.getElementById('login-button').innerText = 'Memverifikasi...';
        document.getElementById('login-alert').style.display = 'none';
        google.script.run.withSuccessHandler(onLoginSuccess).withFailureHandler(onLoginFailure).userLogin(credentials);
    }

    function onLoginSuccess(user) {
        if (user && user.token) {
            localStorage.setItem('authToken', user.token);
            loggedInUser = user;
            localStorage.setItem('loggedInUser', JSON.stringify(user));
            loadInitialData(true);
        } else {
            onLoginFailure("Email atau password salah.");
        }
    }
    
    function onLoginFailure(error) {
        const button = document.getElementById('login-button');
        const alertBox = document.getElementById('login-alert');
        alertBox.innerText = error.toString();
        alertBox.style.display = 'block';
        button.disabled = false;
        button.innerText = 'Login';
    }
    
    function loadInitialData(showDashOnComplete) {
        let loadCount = 2;
        const checkDone = () => {
            loadCount--;
            if (loadCount === 0) {
                localStorage.setItem('cachedMapel', JSON.stringify(cachedMapel));
                localStorage.setItem('cachedTahunAjaran', JSON.stringify(cachedTahunAjaran));
                if (showDashOnComplete) showDashboard();
            }
        };
        google.script.run.withSuccessHandler(data => { cachedMapel = data; checkDone(); }).getAllMapelForGuru(loggedInUser.email);
        google.script.run.withSuccessHandler(data => { cachedTahunAjaran = data; checkDone(); }).getTahunAjaran();
    }

    function showView(viewId, displayType = 'block') {
        ['loading-view', 'login-view', 'dashboard-view', 'input-nilai-view', 'cetak-nilai-view', 'pengaturan-cetak-view'].forEach(id => {
            document.getElementById(id).style.display = 'none';
        });
        document.getElementById(viewId).style.display = displayType;
    }
    
    function backToDashboard() { showView('dashboard-view'); }

    function showDashboard() {
        showView('dashboard-view');
        document.getElementById('welcome-message-dash').innerText = `Halo, ${loggedInUser.nama}`;
        populateTahunAjaran(cachedTahunAjaran, 'status-tahun-ajaran-select', false);
        fetchDashboardStatus();
    }
    
    function populateTahunAjaran(data, selectId, addDefaultOption = false) {
        const select = document.getElementById(selectId);
        select.innerHTML = '';
        if (addDefaultOption) select.innerHTML = '<option value="" selected disabled>-- Pilih --</option>';
        if (data && data.length > 0) {
            data.forEach(item => select.add(new Option(item.deskripsi, item.id_tahun_ajaran)));
        } else {
            select.innerHTML = '<option value="" selected disabled>Tidak ditemukan</option>';
        }
    }
    
    // --- (Fungsi-fungsi lainnya seperti fetchDashboardStatus, populateDashboardStatus, alur input nilai, dll tetap sama) ---

    function fetchDashboardStatus() {
        const selectedTahunAjaranId = document.getElementById('status-tahun-ajaran-select').value;
        document.getElementById('status-table-container').style.display = 'none';
        document.getElementById('status-table-error').style.display = 'none';
        document.getElementById('loading-spinner-status').style.display = 'block';
        if (!selectedTahunAjaranId) {
             populateDashboardStatus([]);
             return;
        }
        google.script.run
            .withSuccessHandler(populateDashboardStatus)
            .withFailureHandler(onStatusLoadFailure)
            .getDashboardStatus(loggedInUser.id_sekolah, selectedTahunAjaranId);
    }

    function populateDashboardStatus(statusData) {
        document.getElementById('loading-spinner-status').style.display = 'none';
        if (statusData.error) { onStatusLoadFailure(statusData.error); return; }
        const tableBody = document.getElementById('status-table-body');
        tableBody.innerHTML = ''; 
        if (statusData && statusData.length > 0) {
            statusData.forEach(item => {
                const statusIcon = item.status ? `<span class="text-success font-weight-bold">✔ Selesai</span>` : `<span class="text-danger">✖ Belum</span>`;
                const actionButton = item.status ? `<button class="btn btn-sm btn-info" onclick="unduhLaporan('${item.email}', '${item.mapel}')">Unduh PDF</button>` : `<button class="btn btn-sm btn-secondary" disabled>Unduh PDF</button>`;
                const row = `<tr><td>${item.nama}</td><td>${item.mapel}</td><td class="text-center">${statusIcon}</td><td class="text-center">${actionButton}</td></tr>`;
                tableBody.innerHTML += row;
            });
            document.getElementById('status-table-container').style.display = 'block';
        } else {
             const select = document.getElementById('status-tahun-ajaran-select');
             const selectedTADescription = select.options[select.selectedIndex]?.text || 'tahun ajaran ini';
             tableBody.innerHTML = `<tr><td colspan="4" class="text-center">Tidak ada data mata pelajaran untuk ${selectedTADescription}.</td></tr>`;
             document.getElementById('status-table-container').style.display = 'block';
        }
    }

    function onStatusLoadFailure(error) {
        console.error("Gagal memuat status dashboard:", error);
        document.getElementById('loading-spinner-status').style.display = 'none';
        document.getElementById('status-table-error').style.display = 'block';
    }

    function goToInputNilai() {
        showView('input-nilai-view');
        populateTahunAjaran(cachedTahunAjaran, 'tahun-ajaran-select-input', true);
        loadMapelForInput();
        document.getElementById('table-card-container').style.display = 'none';
        document.getElementById('loading-spinner-table').style.display = 'none';
    }

    function loadMapelForInput() {
        const taId = document.getElementById('tahun-ajaran-select-input').value;
        const mapelSelect = document.getElementById('mapel-select-input');
        mapelSelect.innerHTML = '';
        const mapelList = taId && cachedMapel[taId] ? cachedMapel[taId] : [];
        if (mapelList.length > 0) {
            mapelSelect.innerHTML = '<option value="" selected disabled>-- Pilih Mapel --</option>';
            mapelList.forEach(m => mapelSelect.add(new Option(m, m)));
        } else {
            mapelSelect.innerHTML = '<option value="" selected disabled>Pilih Tahun Ajaran</option>';
        }
        document.getElementById('table-card-container').style.display = 'none';
        updateTampilkanSiswaButtonState();
    }

    function updateTampilkanSiswaButtonState() {
        const taId = document.getElementById('tahun-ajaran-select-input').value;
        const mapel = document.getElementById('mapel-select-input').value;
        document.getElementById('tampilkan-siswa-btn').disabled = !(taId && mapel);
    }

    function loadNilaiTable() {
        const idTahunAjaran = document.getElementById('tahun-ajaran-select-input').value;
        const mapel = document.getElementById('mapel-select-input').value;
        if (!idTahunAjaran || !mapel) return;
        currentMapelRequestID++;
        const thisRequestID = currentMapelRequestID;
        document.getElementById('table-card-container').style.display = 'none';
        document.getElementById('loading-spinner-table').style.display = 'block';
        document.getElementById('status').innerHTML = '';
        google.script.run
            .withSuccessHandler(onDataLoaded)
            .getSiswaAndNilai(loggedInUser.id_sekolah, mapel, idTahunAjaran, thisRequestID);
    }

    function onDataLoaded(response) {
        if (response.requestID !== currentMapelRequestID) return;
        const tableBody = document.getElementById('nilai-table-body');
        tableBody.innerHTML = ''; 
        const data = response.siswaData; 
        if (data && data.length > 0) {
            data.forEach((item, index) => {
                const row = `<tr><td>${index + 1}</td><td>${item.nama}</td><td><input type="number" class="form-control nilai-input" value="${item.nilai || ''}" min="0" max="100" inputmode="numeric" oninput="this.value = this.value > 100 ? 100 : this.value < 0 ? 0 : this.value" data-nomor-ujian="${item.nomor_ujian}" data-original-nilai="${item.nilai || ''}"></td></tr>`;
                tableBody.innerHTML += row;
            });
        } else {
            tableBody.innerHTML = '<tr><td colspan="3" class="text-center">Data siswa tidak ditemukan.</td></tr>';
        }
        document.getElementById('loading-spinner-table').style.display = 'none';
        document.getElementById('table-card-container').style.display = 'block';
    }

    function submitSemuaNilai() {
        const button = document.getElementById('submit-button');
        const statusDiv = document.getElementById('status');
        const inputs = document.querySelectorAll('#nilai-table-body .nilai-input');
        const dataToSave = [];
        let hasError = false;
        inputs.forEach(input => {
            input.classList.remove('is-invalid');
            const nilai = parseFloat(input.value);
            if (input.value !== '' && (isNaN(nilai) || nilai < 0 || nilai > 100)) {
                input.classList.add('is-invalid'); hasError = true;
            }
            if (input.value !== input.getAttribute('data-original-nilai')) {
                dataToSave.push({ nomorUjian: input.getAttribute('data-nomor-ujian'), nilai: input.value });
            }
        });
        if (hasError) { statusDiv.innerHTML = `<div class="alert alert-danger">Terdapat nilai yang tidak valid (0-100).</div>`; return; }
        if (dataToSave.length === 0) { statusDiv.innerHTML = `<div class="alert alert-info">Tidak ada perubahan data untuk disimpan.</div>`; return; }
        const dataLengkap = dataToSave.map(item => ({
          ...item,
          mapel: document.getElementById('mapel-select-input').value,
          emailGuru: loggedInUser.email,
          id_tahun_ajaran: document.getElementById('tahun-ajaran-select-input').value
        }));
        button.disabled = true;
        statusDiv.innerHTML = `<div class="alert alert-info">Menyimpan ${dataLengkap.length} data perubahan...</div>`;
        google.script.run.withSuccessHandler(onSaveSuccess).simpanAtauUpdateNilai(dataLengkap);
    }
    
    function onSaveSuccess(response) {
        const button = document.getElementById('submit-button');
        const statusDiv = document.getElementById('status');
        if (response.startsWith("Sukses")) {
            statusDiv.innerHTML = `<div class="alert alert-success">${response}</div>`;
            document.querySelectorAll('#nilai-table-body .nilai-input').forEach(input => {
                input.setAttribute('data-original-nilai', input.value);
            });
        } else {
            statusDiv.innerHTML = `<div class="alert alert-danger">${response}</div>`;
        }
        button.disabled = false;
    }

    function goToCetakNilai() {
        showView('cetak-nilai-view');
        populateTahunAjaran(cachedTahunAjaran, 'tahun-ajaran-select-cetak', true);
        loadMapelForCetak();
        document.getElementById('preview-container').style.display = 'none';
        document.getElementById('loading-spinner-cetak').style.display = 'none';
    }

    function loadMapelForCetak() {
        const taId = document.getElementById('tahun-ajaran-select-cetak').value;
        const mapelSelect = document.getElementById('mapel-select-cetak');
        mapelSelect.innerHTML = '';
        const mapelList = taId && cachedMapel[taId] ? cachedMapel[taId] : [];
        if (mapelList.length > 0) {
            mapelSelect.innerHTML = '<option value="" selected disabled>-- Pilih Mapel --</option>';
            mapelList.forEach(m => mapelSelect.add(new Option(m, m)));
        } else {
            mapelSelect.innerHTML = '<option value="" selected disabled>Pilih Tahun Ajaran</option>';
        }
        updatePreviewButtonState();
    }

    function updatePreviewButtonState() {
        const taId = document.getElementById('tahun-ajaran-select-cetak').value;
        const mapel = document.getElementById('mapel-select-cetak').value;
        document.getElementById('tampilkan-preview-btn').disabled = !(taId && mapel);
    }

    function previewCetakNilai() {
        const taSelect = document.getElementById('tahun-ajaran-select-cetak');
        const mapelSelect = document.getElementById('mapel-select-cetak');
        if (!taSelect.value || !mapelSelect.value) return;
        document.getElementById('preview-container').style.display = 'none';
        document.getElementById('loading-spinner-cetak').style.display = 'block';
        const data = {
            id_sekolah: loggedInUser.id_sekolah,
            id_tahun_ajaran: taSelect.value,
            deskripsi_ta: taSelect.options[taSelect.selectedIndex].text,
            nama_mapel: mapelSelect.value,
            email_guru: loggedInUser.email,
        };
        google.script.run.withSuccessHandler(onPreviewDataLoaded).getCetakData(data);
    }
    
    function onPreviewDataLoaded(data) {
        document.getElementById('loading-spinner-cetak').style.display = 'none';
        if (data.error) { alert('Gagal memuat data: ' + data.error); return; }
        document.getElementById('preview-container').style.display = 'block';
        const tahunAjaranParts = data.deskripsi_ta.split('/');
        const tahunLulus = tahunAjaranParts.length > 1 ? tahunAjaranParts[1] : new Date().getFullYear();
        document.getElementById('preview-tahun').innerText = tahunLulus;
        document.getElementById('preview-ta-deskripsi').innerText = data.deskripsi_ta;
        document.getElementById('preview-mapel').innerText = `: ${data.nama_mapel}`;
        document.getElementById('preview-guru').innerText = `: ${data.guru.nama}`;
        const tableBody = document.getElementById('preview-table-body');
        tableBody.innerHTML = '';
        if (data.nilai_siswa.length > 0) {
            data.nilai_siswa.forEach((item, index) => {
                const row = `<tr><td>${index + 1}</td><td>${item.ruang_ujian}</td><td>${item.nomor_ujian}</td><td>${item.nama}</td><td>${item.nilai}</td><td>${item.nilai_huruf}</td></tr>`;
                tableBody.innerHTML += row;
            });
        } else {
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Data nilai tidak ditemukan.</td></tr>';
        }
        document.getElementById('preview-kepsek').innerText = data.sekolah.kepala_sekolah;
        document.getElementById('preview-nip').innerText = data.sekolah.nip_kepsek || '-';
        document.getElementById('preview-guru-ttd').innerText = data.guru.nama;
        document.getElementById('preview-tempat-ttd').innerText = data.pengaturan.tempat || '______';
        document.getElementById('preview-tanggal-ttd').innerText = data.pengaturan.tanggalFormatted || '______';
    }
    
    /**
     * ===== DIPERBARUI: Fungsi pemicu unduhan langsung dari Base64 =====
     */
    function downloadFromBase64(base64Data, fileName) {
        const byteCharacters = atob(base64Data);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], {type: 'application/pdf'});

        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function kirimDanUnduhPdf() {
        const button = document.getElementById('unduh-pdf-btn');
        const statusDiv = document.getElementById('pdf-status');
        button.disabled = true;
        statusDiv.innerHTML = `<div class="alert alert-info">1/2: Mengirim status penyelesaian...</div>`;
        const dataKirim = {
            id_tahun_ajaran: document.getElementById('tahun-ajaran-select-cetak').value,
            nama_mapel: document.getElementById('mapel-select-cetak').value,
            email_guru: loggedInUser.email,
        };
        google.script.run.withSuccessHandler(onStatusSent).withFailureHandler(onPdfError).kirimStatusNilai(dataKirim);
    }

    function onStatusSent(response) {
      if (response.success) {
        const statusDiv = document.getElementById('pdf-status');
        statusDiv.innerHTML = `<div class="alert alert-info">2/2: Status terkirim. Membuat file PDF...</div>`;
        const dataPdf = {
            id_sekolah: loggedInUser.id_sekolah,
            id_tahun_ajaran: document.getElementById('tahun-ajaran-select-cetak').value,
            nama_mapel: document.getElementById('mapel-select-cetak').value,
            email_guru: loggedInUser.email
        };
        // Panggil fungsi backend yang baru
        google.script.run.withSuccessHandler(onPdfDataReceived).withFailureHandler(onPdfError).generatePdfAsBase64(dataPdf);
      } else {
        onPdfError({toString: () => response.error});
      }
    }

    function onPdfDataReceived(response) {
        const button = document.getElementById('unduh-pdf-btn');
        const statusDiv = document.getElementById('pdf-status');
        if (response.base64Data) {
            statusDiv.innerHTML = `<div class="alert alert-success">PDF berhasil dibuat! Unduhan akan dimulai secara otomatis.</div>`;
            // Panggil fungsi unduhan langsung
            downloadFromBase64(response.base64Data, response.fileName);
        } else {
            onPdfError({toString: () => response.error});
        }
        button.disabled = false;
    }

    function onPdfError(error) {
        document.getElementById('unduh-pdf-btn').disabled = false;
        document.getElementById('pdf-status').innerHTML = `<div class="alert alert-danger">Terjadi kesalahan: ${error.toString()}</div>`;
    }

    function unduhLaporan(emailGuru, namaMapel) {
        const statusTASelect = document.getElementById('status-tahun-ajaran-select');
        const taDeskripsi = statusTASelect.options[statusTASelect.selectedIndex].text;
        alert(`Memulai proses unduhan untuk ${namaMapel} (${taDeskripsi}). Mohon tunggu...`);
        const dataPdf = {
            id_sekolah: loggedInUser.id_sekolah,
            id_tahun_ajaran: statusTASelect.value,
            nama_mapel: namaMapel,
            email_guru: emailGuru
        };
        google.script.run.withSuccessHandler(onPdfDataReceivedFromDashboard).withFailureHandler(alert).generatePdfAsBase64(dataPdf);
    }
    
    function onPdfDataReceivedFromDashboard(response) {
        if (response.base64Data) {
            downloadFromBase64(response.base64Data, response.fileName);
        } else {
            alert("Gagal membuat PDF: " + (response.error || "Kesalahan tidak diketahui."));
        }
    }
    
    // --- (Fungsi-fungsi pengaturan cetak dan utility lainnya tetap sama) ---
    
    function goToPengaturanCetak() {
        showView('pengaturan-cetak-view');
        document.getElementById('pengaturan-status').innerHTML = '';
        const tempatInput = document.getElementById('tempat-ttd');
        const tanggalInput = document.getElementById('tanggal-ttd');
        const simpanBtn = document.getElementById('simpan-pengaturan-btn');
        tempatInput.value = '';
        tempatInput.placeholder = 'Memuat data...';
        tanggalInput.value = '';
        tempatInput.disabled = true;
        tanggalInput.disabled = true;
        simpanBtn.disabled = true;
        google.script.run.withSuccessHandler(onPengaturanLoaded).getPengaturanCetak(loggedInUser.email);
    }

    function onPengaturanLoaded(pengaturan) {
        cachedPengaturan = pengaturan;
        localStorage.setItem('cachedPengaturan', JSON.stringify(pengaturan));
        const tempatInput = document.getElementById('tempat-ttd');
        const tanggalInput = document.getElementById('tanggal-ttd');
        const simpanBtn = document.getElementById('simpan-pengaturan-btn');
        tempatInput.placeholder = 'Contoh: Butung';
        tempatInput.disabled = false;
        tanggalInput.disabled = false;
        simpanBtn.disabled = false;
        tempatInput.value = pengaturan.tempat || '';
        tanggalInput.value = pengaturan.tanggal || '';
    }

    function simpanPengaturanCetak() {
        const tempat = document.getElementById('tempat-ttd').value;
        const tanggal = document.getElementById('tanggal-ttd').value;
        const statusDiv = document.getElementById('pengaturan-status');
        const button = document.getElementById('simpan-pengaturan-btn');
        statusDiv.innerHTML = `<div class="alert alert-info">Menyimpan...</div>`;
        button.disabled = true;
        const pengaturan = { email: loggedInUser.email, tempat: tempat, tanggal: tanggal };
        google.script.run.withSuccessHandler(onPengaturanSaved).withFailureHandler(onPengaturanSaveFailed).savePengaturanCetak(pengaturan);
    }

    function onPengaturanSaved(response) {
        const statusDiv = document.getElementById('pengaturan-status');
        document.getElementById('simpan-pengaturan-btn').disabled = false;
        if(response.success) {
            statusDiv.innerHTML = `<div class="alert alert-success">Pengaturan berhasil disimpan.</div>`;
            cachedPengaturan = { tempat: document.getElementById('tempat-ttd').value, tanggal: document.getElementById('tanggal-ttd').value };
            localStorage.setItem('cachedPengaturan', JSON.stringify(cachedPengaturan));
        } else {
            statusDiv.innerHTML = `<div class="alert alert-danger">Gagal menyimpan: ${response.error}</div>`;
        }
    }
    
    function onPengaturanSaveFailed(error) {
        document.getElementById('simpan-pengaturan-btn').disabled = false;
        const statusDiv = document.getElementById('pengaturan-status');
        statusDiv.innerHTML = `<div class="alert alert-danger">Terjadi kesalahan: ${error.toString()}</div>`;
    }
    
    function logout() {
        localStorage.clear();
        forceLogout();
    }

    function forceLogout() {
        loggedInUser = null;
        cachedTahunAjaran = null;
        cachedMapel = null; 
        cachedPengaturan = null;
        showView('login-view', 'flex');
        document.getElementById('email').value = '';
        document.getElementById('password').value = '';
        const loginButton = document.getElementById('login-button');
        if(loginButton) {
            loginButton.disabled = false;
            loginButton.innerText = 'Login';
        }
    }

</script>
</body>
</html>
