/**
 * @fileoverview Backend untuk Aplikasi Input Nilai Madrasah.
 * Mengelola otentikasi, pengambilan data, dan penyimpanan nilai.
 * @version 2.2
 * @author Peningkatan Performa oleh Gemini, Fitur Kunci oleh Gemini
 * @description
 * Versi 2.1: Menambahkan fitur untuk mengunci Tahun Ajaran.
 * Versi 2.2: Memperbaiki masalah perbedaan tanggal cetak akibat zona waktu (timezone).
 */

// Konstanta Global untuk Akses Cepat ke Spreadsheet
const SS = SpreadsheetApp.getActiveSpreadsheet();
const GURU_SHEET = SS.getSheetByName('db_guru');
const SISWA_SHEET = SS.getSheetByName('db_siswa');
const TAHUN_AJARAN_SHEET = SS.getSheetByName('db_tahun_ajaran');
const ENROLLMENT_SHEET = SS.getSheetByName('db_enrollment');
const MAPEL_SHEET = SS.getSheetByName('db_mapel');
const SEKOLAH_SHEET = SS.getSheetByName('db_sekolah');
const PENGATURAN_CETAK_SHEET = SS.getSheetByName('db_pengaturan_cetak');
const STATUS_KIRIM_SHEET = SS.getSheetByName('db_status_kirim');

// Cache untuk menyimpan referensi sheet yang sudah diakses agar tidak perlu dicari berulang kali.
const sheetCache = {};

/**
 * ===== BARU: Fungsi Helper untuk Mengecek Status Kunci Tahun Ajaran =====
 * Mengecek apakah suatu tahun ajaran sudah dikunci atau belum.
 * @param {string} id_tahun_ajaran - ID unik dari tahun ajaran.
 * @returns {boolean} True jika terkunci, false jika tidak.
 */
function isTahunAjaranLocked(id_tahun_ajaran) {
  const taData = TAHUN_AJARAN_SHEET.getDataRange().getValues();
  for (let i = 1; i < taData.length; i++) {
    // taData[i][0] adalah id_tahun_ajaran, taData[i][2] adalah kolom status_kunci
    if (taData[i][0] == id_tahun_ajaran && taData[i][2] === true) {
      return true;
    }
  }
  return false;
}

/**
 * ===== BARU: Fungsi Helper untuk Mengelola Sheet Nilai per Tahun Ajaran =====
 * Membuat atau mendapatkan sheet untuk menyimpan nilai berdasarkan ID tahun ajaran.
 * @param {string} id_tahun_ajaran - ID unik dari tahun ajaran.
 * @returns {Sheet} Objek Sheet dari Google Spreadsheet yang sesuai.
 */
function getNilaiSheetByTahunAjaran(id_tahun_ajaran) {
  if (sheetCache[id_tahun_ajaran]) {
    return sheetCache[id_tahun_ajaran];
  }

  const taData = TAHUN_AJARAN_SHEET.getDataRange().getValues();
  let deskripsi = '';
  for (let i = 1; i < taData.length; i++) {
    if (taData[i][0] == id_tahun_ajaran) {
      deskripsi = taData[i][1];
      break;
    }
  }

  if (!deskripsi) {
    throw new Error(`Tahun Ajaran dengan ID "${id_tahun_ajaran}" tidak ditemukan.`);
  }

  const sheetName = `db_nilai_${deskripsi.replace('/', '-')}`;
  let sheet = SS.getSheetByName(sheetName);

  if (!sheet) {
    sheet = SS.insertSheet(sheetName);
    const headers = [
      "id_nilai", "nomor_ujian", "mapel", "nilai", "email_guru",
      "timestamp", "id_tahun_ajaran"
    ];
    sheet.appendRow(headers);
    sheet.getRange("A1:G1").setFontWeight("bold");
    sheet.setFrozenRows(1);
  }

  sheetCache[id_tahun_ajaran] = sheet;
  return sheet;
}

function doGet() {
  return HtmlService.createHtmlOutputFromFile('Index')
    .setTitle('Input Nilai Ujian Madrasah')
    .setFaviconUrl("https://i.imgur.com/JZpABrR.png")
    .addMetaTag('viewport', 'width=device-width, initial-scale=1.0');
}

/**
 * ===== DIPERBARUI: Mengambil status kunci tahun ajaran =====
 * Menggabungkan pengambilan tahun ajaran (beserta status kuncinya) dan mapel
 * untuk mempercepat loading awal.
 * @param {string} email - Email guru yang login.
 * @returns {Object} Objek berisi data tahun ajaran dan mapel dengan status.
 */
function getInitialDataForGuru(email) {
  try {
    const taData = TAHUN_AJARAN_SHEET.getDataRange().getValues().slice(1);
    const allTahunAjaran = taData.map(row => ({
      id_tahun_ajaran: row[0],
      deskripsi: row[1],
      is_locked: row[2] === true // Kolom C (index 2) adalah status_kunci
    })).reverse();

    const mapelData = MAPEL_SHEET.getDataRange().getValues().slice(1);
    const guruMapelList = mapelData
      .filter(row => row[0].toLowerCase() === email.toLowerCase())
      .map(row => ({ id_tahun_ajaran: row[2], mapel: row[1] }));

    if (guruMapelList.length === 0) {
      return { tahunAjaran: allTahunAjaran, mapelWithStatus: {} };
    }

    const statusData = STATUS_KIRIM_SHEET.getDataRange().getValues().slice(1);
    const sentStatusSet = statusData
      .filter(row => row[2].toLowerCase() === email.toLowerCase())
      .reduce((set, row) => {
        const key = `${row[1]}_${row[3]}`;
        set.add(key);
        return set;
      }, new Set());

    const mapelWithStatus = guruMapelList.reduce((acc, item) => {
      const taId = item.id_tahun_ajaran;
      if (!acc[taId]) {
        acc[taId] = [];
      }
      const key = `${taId}_${item.mapel}`;
      acc[taId].push({
        mapel: item.mapel,
        status: sentStatusSet.has(key)
      });
      return acc;
    }, {});

    for (const taId in mapelWithStatus) {
        mapelWithStatus[taId].sort((a, b) => a.mapel.localeCompare(b.mapel));
    }

    return {
      tahunAjaran: allTahunAjaran,
      mapelWithStatus: mapelWithStatus
    };
  } catch (e) {
    Logger.log(e);
    return { error: e.toString() };
  }
}

function userLogin(credentials) {
  if (!credentials || !credentials.email || !credentials.password) return null;
  const dataGuru = GURU_SHEET.getDataRange().getValues();
  for (let i = 1; i < dataGuru.length; i++) {
    const row = dataGuru[i];
    if (row[0].toLowerCase() === credentials.email.toLowerCase() && row[1] === credentials.password) {
      return { email: row[0], nama: row[2], id_sekolah: row[3], token: row[5] };
    }
  }
  return null;
}

function verifyToken(token) {
  if (!token) return null;
  const dataGuru = GURU_SHEET.getDataRange().getValues();
  for (let i = 1; i < dataGuru.length; i++) {
    const row = dataGuru[i];
    if (row[5] === token) {
      return { email: row[0], nama: row[2], id_sekolah: row[3], token: row[5] };
    }
  }
  return null;
}

function getTahunAjaran() {
  const data = TAHUN_AJARAN_SHEET.getDataRange().getValues().slice(1);
  return data.map(row => ({
    id_tahun_ajaran: row[0],
    deskripsi: row[1],
    is_locked: row[2] === true
  })).reverse();
}

/**
 * ===== DIPERBARUI: Mengirim status kunci tahun ajaran ke frontend =====
 * Mengambil data siswa dan nilai, serta mengecek apakah tahun ajaran terkunci.
 */
function getSiswaAndNilai(id_sekolah, nama_mapel, id_tahun_ajaran, requestID, email_guru) {
  const isLocked = isTahunAjaranLocked(id_tahun_ajaran);

  const NILAI_SHEET = getNilaiSheetByTahunAjaran(id_tahun_ajaran);
  const enrollmentData = ENROLLMENT_SHEET.getDataRange().getValues().slice(1);
  const enrolledSiswa = enrollmentData
    .filter(row => String(row[2]).trim() == String(id_sekolah).trim() && String(row[3]).trim() == String(id_tahun_ajaran).trim())
    .map(row => ({ nomor_ujian: row[1], ruang_ujian: row[4] || 'N/A' }));

  if (enrolledSiswa.length === 0) {
    return { siswaData: [], requestID: requestID, isSudahKirim: false, isTahunAjaranLocked: isLocked };
  }
  
  const masterSiswaMap = SISWA_SHEET.getDataRange().getValues().slice(1)
    .reduce((map, row) => { map[row[0]] = row[1]; return map; }, {});
    
  const nilaiData = NILAI_SHEET.getDataRange().getValues().slice(1);
  const nilaiMap = nilaiData
    .filter(row => row[2] == nama_mapel)
    .reduce((map, row) => { map[row[1]] = row[3]; return map; }, {});

  const result = enrolledSiswa.map(item => ({
    nomor_ujian: item.nomor_ujian,
    ruang_ujian: item.ruang_ujian,
    nama: masterSiswaMap[item.nomor_ujian] || 'Nama Tdk Ditemukan',
    nilai: nilaiMap.hasOwnProperty(item.nomor_ujian) ? nilaiMap[item.nomor_ujian] : ''
  })).sort((a, b) => a.nama.localeCompare(b.nama));
  
  const keyCek = `${id_tahun_ajaran}_${email_guru.toLowerCase()}_${nama_mapel}`;
  const statusData = STATUS_KIRIM_SHEET.getDataRange().getValues().slice(1);
  const sentStatusSet = statusData.reduce((set, row) => { set.add(row[0]); return set; }, new Set());
  const isSudahKirim = sentStatusSet.has(keyCek);

  return { siswaData: result, requestID: requestID, isSudahKirim: isSudahKirim, isTahunAjaranLocked: isLocked };
}

/**
 * ===== DIPERBARUI: Menambahkan proteksi untuk tahun ajaran yang terkunci =====
 * Menyimpan atau memperbarui nilai hanya jika tahun ajaran tidak terkunci.
 */
function simpanAtauUpdateNilai(dataNilai) {
  if (!dataNilai || dataNilai.length === 0) return "Error: Tidak ada data untuk diproses.";
  const { id_tahun_ajaran } = dataNilai[0];

  if (isTahunAjaranLocked(id_tahun_ajaran)) {
    return "Error: Gagal menyimpan. Tahun Ajaran ini telah dikunci dan tidak dapat diubah lagi.";
  }

  const { mapel, emailGuru } = dataNilai[0];
  const NILAI_SHEET = getNilaiSheetByTahunAjaran(id_tahun_ajaran);
  const allNilai = NILAI_SHEET.getDataRange().getValues();
  const existingDataMap = allNilai.reduce((map, row, index) => {
    if (index > 0) {
      const key = `${row[1]}_${row[2]}`; 
      map[key] = index; 
    }
    return map;
  }, {});

  let updatedCount = 0, insertedCount = 0, deletedCount = 0;

  dataNilai.forEach(item => {
    const key = `${item.nomorUjian}_${mapel}`;
    const rowIndex = existingDataMap[key];
    const nilaiIsFilled = item.nilai !== '' && item.nilai !== null;

    if (rowIndex) {
      NILAI_SHEET.getRange(rowIndex + 1, 4).setValue(item.nilai);
      NILAI_SHEET.getRange(rowIndex + 1, 6).setValue(new Date());
      nilaiIsFilled ? updatedCount++ : deletedCount++;
    } else if (nilaiIsFilled) {
      NILAI_SHEET.appendRow([
        new Date().getTime(), item.nomorUjian, mapel, item.nilai, 
        emailGuru, new Date(), id_tahun_ajaran
      ]);
      insertedCount++;
    }
  });

  const totalProcessed = updatedCount + insertedCount + deletedCount;
  return `Sukses! ${totalProcessed} data diproses (${insertedCount} baru, ${updatedCount} diperbarui, ${deletedCount} dikosongkan).`;
}

/**
 * ===== DIPERBARUI: Menambahkan proteksi untuk tahun ajaran yang terkunci =====
 */
function kirimStatusNilai(data) {
  try {
    const { id_tahun_ajaran, email_guru, nama_mapel } = data;

    if (isTahunAjaranLocked(id_tahun_ajaran)) {
      return { success: false, error: "Gagal mengirim. Tahun Ajaran ini telah dikunci." };
    }

    const key = `${id_tahun_ajaran}_${email_guru.toLowerCase()}_${nama_mapel}`;
    const statusData = STATUS_KIRIM_SHEET.getDataRange().getValues();
    const existingKeys = statusData.map(row => row[0]);
    if (!existingKeys.includes(key)) {
      STATUS_KIRIM_SHEET.appendRow([key, id_tahun_ajaran, email_guru, nama_mapel, new Date()]);
    }
    return { success: true, message: "Status berhasil dikirim." };
  } catch (e) {
    Logger.log(e);
    return { success: false, error: e.toString() };
  }
}

/**
 * ===== DIPERBARUI: Menambahkan proteksi untuk tahun ajaran yang terkunci =====
 */
function batalKirimStatusNilai(data) {
  const lock = LockService.getScriptLock();
  lock.waitLock(15000);
  try {
    const { id_tahun_ajaran, email_guru, nama_mapel } = data;
    
    if (isTahunAjaranLocked(id_tahun_ajaran)) {
      return { success: false, error: "Gagal membatalkan. Tahun Ajaran ini telah dikunci." };
    }

    const keyToFind = `${id_tahun_ajaran}_${email_guru.toLowerCase()}_${nama_mapel}`;
    const range = STATUS_KIRIM_SHEET.getDataRange();
    const values = range.getValues();
    
    for (let i = values.length - 1; i >= 1; i--) {
      if (values[i][0] === keyToFind) {
        STATUS_KIRIM_SHEET.deleteRow(i + 1);
        return { success: true, message: "Status berhasil dibatalkan." };
      }
    }
    return { success: true, message: "Status tidak ditemukan (mungkin sudah dibatalkan)." };
  } catch (e) {
    Logger.log(e);
    return { success: false, error: e.toString() };
  } finally {
    lock.releaseLock();
  }
}

function getDashboardStatus(id_sekolah, id_tahun_ajaran) {
  try {
    if (!id_tahun_ajaran) return [];
    const guruData = GURU_SHEET.getDataRange().getValues().slice(1);
    const guruDiSekolahMap = guruData.filter(row => row[3] == id_sekolah)
      .reduce((map, row) => { map[row[0].toLowerCase()] = row[2]; return map; }, {});
    const emailsGuruDiSekolah = Object.keys(guruDiSekolahMap);
    const mapelData = MAPEL_SHEET.getDataRange().getValues().slice(1);
    const guruMapelList = mapelData
      .filter(row => emailsGuruDiSekolah.includes(row[0].toLowerCase()) && row[2] == id_tahun_ajaran)
      .map(row => ({ email: row[0].toLowerCase(), nama: guruDiSekolahMap[row[0].toLowerCase()], mapel: row[1] }));
    const statusData = STATUS_KIRIM_SHEET.getDataRange().getValues().slice(1);
    const sentStatusSet = statusData
      .filter(row => row[1] == id_tahun_ajaran)
      .reduce((set, row) => { const key = `${row[1]}_${row[2].toLowerCase()}_${row[3]}`; set.add(key); return set; }, new Set());
    const result = guruMapelList.map(item => {
        const keyCek = `${id_tahun_ajaran}_${item.email}_${item.mapel}`;
        return { nama: item.nama, mapel: item.mapel, email: item.email, status: sentStatusSet.has(keyCek) };
    }).sort((a, b) => a.nama.localeCompare(b.nama) || a.mapel.localeCompare(b.mapel));
    return result;
  } catch (e) {
    Logger.log(e);
    return { error: e.toString() };
  }
}

/**
 * ===== DIPERBARUI: Mengirim status kunci tahun ajaran ke frontend dan memperbaiki penanganan tanggal =====
 */
function getCetakData(req) {
  try {
    const isLocked = isTahunAjaranLocked(req.id_tahun_ajaran);
    const nilaiSiswaData = getSiswaAndNilai(req.id_sekolah, req.nama_mapel, req.id_tahun_ajaran, 0, req.email_guru).siswaData;
    const nilaiSiswa = nilaiSiswaData.map(s => ({ 
      ...s, 
      nilai_huruf: (s.nilai !== '' && s.nilai !== null && s.nilai !== undefined) ? terbilang(s.nilai) : '' 
    }));
    
    const sekolahData = SEKOLAH_SHEET.getDataRange().getValues().slice(1);
    const sekolahInfoRow = sekolahData.find(row => row[0] == req.id_sekolah);
    const sekolahInfo = { kepala_sekolah: sekolahInfoRow ? sekolahInfoRow[3] : 'Tdk Ditemukan', nip_kepsek: sekolahInfoRow ? sekolahInfoRow[4] : '-' };
    const guruData = GURU_SHEET.getDataRange().getValues().slice(1);
    const guruInfoRow = guruData.find(row => row[0].toLowerCase() === req.email_guru.toLowerCase());
    const guruInfo = { nama: guruInfoRow ? guruInfoRow[2] : 'Guru Tdk Ditemukan' };
    const pengaturan = getPengaturanCetak(req.email_guru);

    // [PERBAIKAN] Logika baru untuk menangani tanggal agar tidak bergeser karena zona waktu
    if (pengaturan.tanggal) {
        // String tanggal 'yyyy-MM-dd' dari sheet di-parse sebagai UTC oleh `new Date()`.
        // Untuk menghindari pergeseran hari, kita buat objek Date baru dari komponen tahun, bulan, dan hari
        // yang akan menggunakan zona waktu lokal skrip, bukan UTC.
        const parts = pengaturan.tanggal.split('-');
        const year = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1; // Bulan di JavaScript dimulai dari 0 (Januari)
        const day = parseInt(parts[2], 10);
        const d = new Date(year, month, day);
        
        pengaturan.tanggalFormatted = d.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
    }

    const keyCek = `${req.id_tahun_ajaran}_${req.email_guru.toLowerCase()}_${req.nama_mapel}`;
    const statusData = STATUS_KIRIM_SHEET.getDataRange().getValues().slice(1);
    const sentStatusSet = statusData.reduce((set, row) => { set.add(row[0]); return set; }, new Set());
    const isSudahKirim = sentStatusSet.has(keyCek);
    return { 
      nilai_siswa: nilaiSiswa, 
      sekolah: sekolahInfo, 
      guru: guruInfo, 
      pengaturan: pengaturan, 
      deskripsi_ta: req.deskripsi_ta, 
      nama_mapel: req.nama_mapel,
      isSudahKirim: isSudahKirim,
      isTahunAjaranLocked: isLocked
    };
  } catch (e) {
    return { error: e.toString() };
  }
}


function generatePdfAsBase64(data) {
  const lock = LockService.getScriptLock();
  lock.waitLock(30000); 

  let tempFileId; 

  try {
    const { id_sekolah, id_tahun_ajaran, nama_mapel, email_guru } = data;
    
    const taInfo = TAHUN_AJARAN_SHEET.getDataRange().getValues().slice(1).find(row => row[0] == id_tahun_ajaran);
    const deskripsi_ta = taInfo ? taInfo[1] : 'N/A';
    const req = { id_sekolah, nama_mapel, id_tahun_ajaran, email_guru, deskripsi_ta };
    const allData = getCetakData(req);

    const sekolahData = SEKOLAH_SHEET.getDataRange().getValues();
    const sekolahRow = sekolahData.find(row => row[0] == id_sekolah);
    if (!sekolahRow || !sekolahRow[5]) {
      throw new Error("ID Template Google Doc tidak ditemukan untuk sekolah ini.");
    }
    const templateId = sekolahRow[5];
    const templateFile = DriveApp.getFileById(templateId);

    const uniqueString = Utilities.getUuid();
    const tempFileName = `TEMP_DOC_${nama_mapel}_${uniqueString}`;
    const newFile = templateFile.makeCopy(tempFileName, DriveApp.getRootFolder());
    tempFileId = newFile.getId();

    const doc = DocumentApp.openById(tempFileId);
    const body = doc.getBody();

    const tahunAjaranParts = allData.deskripsi_ta.split('/');
    const tahunLulus = tahunAjaranParts.length > 1 ? tahunAjaranParts[1] : new Date().getFullYear();
    body.replaceText('{{nama_mapel}}', allData.nama_mapel.toUpperCase());
    body.replaceText('{{tahun_lulus}}', tahunLulus);
    body.replaceText('{{tahun_pelajaran}}', allData.deskripsi_ta);
    body.replaceText('{{guru_pemeriksa}}', allData.guru.nama);
    body.replaceText('{{nama_kepala_sekolah}}', allData.sekolah.kepala_sekolah);
    body.replaceText('{{nip_kepala_sekolah}}', allData.sekolah.nip_kepsek || '-');
    body.replaceText('{{tempat_ttd}}', allData.pengaturan.tempat || '______');
    body.replaceText('{{tanggal_ttd}}', allData.pengaturan.tanggalFormatted || '______');
    
    const table = body.getTables()[0];
    if (table) {
        let textStyle = {}; textStyle[DocumentApp.Attribute.BOLD] = false;
        allData.nilai_siswa.forEach((item, index) => {
          const row = table.appendTableRow();
          let cell0 = row.appendTableCell((index + 1).toString());
          cell0.setVerticalAlignment(DocumentApp.VerticalAlignment.CENTER).getChild(0).asParagraph().setAlignment(DocumentApp.HorizontalAlignment.CENTER).setAttributes(textStyle);
          let cell1 = row.appendTableCell(item.ruang_ujian.toString());
          cell1.setVerticalAlignment(DocumentApp.VerticalAlignment.CENTER).getChild(0).asParagraph().setAlignment(DocumentApp.HorizontalAlignment.CENTER).setAttributes(textStyle);
          let cell2 = row.appendTableCell(item.nomor_ujian.toString());
          cell2.setVerticalAlignment(DocumentApp.VerticalAlignment.CENTER).getChild(0).asParagraph().setAlignment(DocumentApp.HorizontalAlignment.CENTER).setAttributes(textStyle);
          let cell3 = row.appendTableCell(item.nama.toString());
          cell3.setVerticalAlignment(DocumentApp.VerticalAlignment.CENTER).getChild(0).asParagraph().setAlignment(DocumentApp.HorizontalAlignment.LEFT).setAttributes(textStyle);
          let cell4 = row.appendTableCell(item.nilai.toString());
          cell4.setVerticalAlignment(DocumentApp.VerticalAlignment.CENTER).getChild(0).asParagraph().setAlignment(DocumentApp.HorizontalAlignment.CENTER).setAttributes(textStyle);
          let cell5 = row.appendTableCell(item.nilai_huruf.toString());
          cell5.setVerticalAlignment(DocumentApp.VerticalAlignment.CENTER).getChild(0).asParagraph().setAlignment(DocumentApp.HorizontalAlignment.LEFT).setAttributes(textStyle);
        });
    } else {
        throw new Error("Tidak ada tabel yang ditemukan di dalam template Google Doc.");
    }
    doc.saveAndClose();

    const pdfBlob = newFile.getAs('application/pdf');
    const base64Data = Utilities.base64Encode(pdfBlob.getBytes());
    
    const finalFileName = `Nilai_${nama_mapel}_${allData.guru.nama}_${deskripsi_ta.replace('/', '-')}.pdf`;

    return { base64Data: base64Data, fileName: finalFileName };

  } catch (e) {
    Logger.log(e);
    return { error: e.toString() };
  } finally {
    if (tempFileId) {
      DriveApp.getFileById(tempFileId).setTrashed(true);
    }
    lock.releaseLock();
  }
}

function savePengaturanCetak(pengaturan) {
  try {
    const data = PENGATURAN_CETAK_SHEET.getDataRange().getValues();
    let rowIndex = -1;
    for (let i = 1; i < data.length; i++) {
      if (data[i][0].toLowerCase() === pengaturan.email.toLowerCase()) {
        rowIndex = i + 1;
        break;
      }
    }
    if (rowIndex > -1) {
      PENGATURAN_CETAK_SHEET.getRange(rowIndex, 2).setValue(pengaturan.tempat);
      PENGATURAN_CETAK_SHEET.getRange(rowIndex, 3).setValue(pengaturan.tanggal);
    } else {
      PENGATURAN_CETAK_SHEET.appendRow([pengaturan.email, pengaturan.tempat, pengaturan.tanggal]);
    }
    return { success: true };
  } catch (e) {
    return { success: false, error: e.toString() };
  }
}

function getPengaturanCetak(email) {
  try {
    const data = PENGATURAN_CETAK_SHEET.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      if (data[i][0].toLowerCase() === email.toLowerCase()) {
        let tanggal = data[i][2];
        if (tanggal instanceof Date) {
          tanggal = Utilities.formatDate(tanggal, Session.getScriptTimeZone(), "yyyy-MM-dd");
        }
        return { tempat: data[i][1], tanggal: tanggal };
      }
    }
    return {};
  } catch(e) {
    return {};
  }
}

function terbilang(n) {
    if (n < 0 || n > 100 || isNaN(n) || n === '') return '';
    if (n === 100) return 'Seratus';
    if (n === 0) return 'Nol';
    const satuan = ["", "Satu", "Dua", "Tiga", "Empat", "Lima", "Enam", "Tujuh", "Delapan", "Sembilan", "Sepuluh", "Sebelas"];
    if (n < 12) return satuan[n];
    if (n < 20) return satuan[n - 10] + " Belas";
    const puluhan = Math.floor(n / 10);
    const sisa = n % 10;
    return (satuan[puluhan] + " Puluh") + (sisa === 0 ? '' : " " + satuan[sisa]);
}

function generateTokensForAllGurus() {
  const range = GURU_SHEET.getDataRange();
  const values = range.getValues();
  for (let i = 1; i < values.length; i++) {
    if (!values[i][5]) {
      const email = values[i][0];
      const randomString = Math.random().toString(36).substring(2, 10);
      const token = `tok_${email.split('@')[0]}_${randomString}`;
      GURU_SHEET.getRange(i + 1, 6).setValue(token);
    }
  }
  SpreadsheetApp.getUi().alert('Proses pembuatan token selesai!');
}
